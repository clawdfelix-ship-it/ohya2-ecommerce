<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨‚å–® - OHYA2.0 Admin</title>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #f5f5f5; }
    .nav { background: #1a1a2e; padding: 10px; overflow-x: auto; white-space: nowrap; }
    .nav a { color: #fff; text-decoration: none; padding: 10px 15px; display: inline-block; font-size: 14px; }
    .nav a.active { background: #ec4899; border-radius: 5px; }
    .main { padding: 15px; }
    h2 { margin: 0 0 10px 0; font-size: 16px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .toolbar-left { flex: 1; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f9fafb; }
    .btn { padding: 8px 14px; background: #6366f1; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn:hover { background: #4f46e5; }
    .btn-secondary { background: #9ca3af; }
    .btn-danger { background: #ef4444; }
    .btn-sm { padding: 5px 10px; font-size: 11px; }
    .checkbox { width: 18px; height: 18px; }
    .selected-bar { display: none; background: #e0e7ff; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; }
    .selected-bar.active { display: flex; align-items: center; gap: 10px; }
    .selected-count { font-weight: bold; color: #3730a3; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">ğŸ“Š ç¸½è¦½</a>
    <a href="orders.html" class="active">ğŸ›’ è¨‚å–®</a>
    <a href="categories.html">ğŸ·ï¸ åˆ†é¡</a>
    <a href="products.html">ğŸ“¦ ç”¢å“</a>
    <a href="customers.html">ğŸ‘¥ å®¢æˆ¶</a>
    <a href="inventory.html">ğŸ“ˆ åº«å­˜</a>
    <a href="coupons.html">ğŸŸï¸ å„ªæƒ ç¢¼</a>
    <a href="settings.html">âš™ï¸ è¨­å®š</a>
  </div>
  <div class="main">
    <h2>ğŸ›’ è¨‚å–®ç®¡ç†</h2>
    
    <!-- æ‰¹æ¬¡æ“ä½œBar -->
    <div class="selected-bar" id="selected-bar">
      <span class="selected-count">å·²é¸æ“‡ <span id="selected-count">0</span> å¼µè¨‚å–®</span>
      <button class="btn" onclick="batchUpdateStatus()">æ”¹ç‹€æ…‹</button>
      <button class="btn btn-danger" onclick="batchDelete()">åˆªé™¤æ‰€é¸</button>
      <button class="btn btn-secondary" onclick="clearSelection()">æ¸…é™¤é¸æ“‡</button>
    </div>
    
    <div class="toolbar">
      <div class="toolbar-left">
        <a href="order-new.html" class="btn">+ æ–°å¢è¨‚å–®</a>
      </div>
      <select id="filter-status" onchange="filterOrders()" style="padding:8px;border:1px solid #ddd;border-radius:5px;">
        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
        <option value="pending">å¾…è™•ç†</option>
        <option value="processing">è™•ç†ä¸­</option>
        <option value="shipped">å·²ç™¼è²¨</option>
        <option value="completed">å·²å®Œæˆ</option>
        <option value="cancelled">å·²å–æ¶ˆ</option>
      </select>
    </div>
    
    <table id="orders-table">
      <thead>
        <tr>
          <th><input type="checkbox" class="checkbox" onchange="toggleAll(this)"></th>
          <th>ID</th>
          <th>å®¢æˆ¶</th>
          <th>ç”¢å“</th>
          <th>ç¸½é¡</th>
          <th>ç‹€æ…‹</th>
          <th>æ—¥æœŸ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="orders-body">
        <tr><td colspan="8">è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
  
  <script>
    var orders = [];
    var selectedIds = [];
    
    fetch('/api/orders').then(function(r){return r.json();}).then(function(d){
      orders = d;
      renderOrders(d);
    });
    
    function renderOrders(list) {
      var html = '';
      list.forEach(function(o){
        var items = o.items || [];
        var productsText = items.slice(0,2).map(function(i){return i.product_name || 'Product';}).join(', ');
        if(items.length > 2) productsText += '...';
        
        var checked = selectedIds.indexOf(o.id) >= 0 ? 'checked' : '';
        
        html += '<tr>' +
          '<td><input type="checkbox" class="checkbox" ' + checked + ' onchange="toggleSelect(' + o.id + ')"></td>' +
          '<td>#' + o.id + '</td>' +
          '<td>' + (o.customer_name || 'Guest') + '</td>' +
          '<td>' + (productsText || '-') + '</td>' +
          '<td>$' + (o.total || 0) + '</td>' +
          '<td><span class="badge badge-' + (o.status || 'pending') + '">' + (o.status || 'pending') + '</span></td>' +
          '<td>' + (o.created_at || '-').substring(0,10) + '</td>' +
          '<td><a href="order-edit.html?id=' + o.id + '" class="btn btn-sm">ç·¨è¼¯</a></td>' +
        '</tr>';
      });
      document.getElementById('orders-body').innerHTML = html || '<tr><td colspan="8">æš«ç„¡è¨‚å–®</td></tr>';
    }
    
    function toggleSelect(id) {
      var idx = selectedIds.indexOf(id);
      if(idx >= 0) {
        selectedIds.splice(idx, 1);
      } else {
        selectedIds.push(id);
      }
      updateSelectedBar();
    }
    
    function toggleAll(checkbox) {
      if(checkbox.checked) {
        var filtered = getFilteredOrders();
        selectedIds = filtered.map(function(o){return o.id;});
      } else {
        selectedIds = [];
      }
      renderOrders(getFilteredOrders());
      updateSelectedBar();
    }
    
    function updateSelectedBar() {
      var bar = document.getElementById('selected-bar');
      var count = document.getElementById('selected-count');
      count.innerText = selectedIds.length;
      if(selectedIds.length > 0) {
        bar.classList.add('active');
      } else {
        bar.classList.remove('active');
      }
    }
    
    function clearSelection() {
      selectedIds = [];
      renderOrders(getFilteredOrders());
      updateSelectedBar();
    }
    
    function getFilteredOrders() {
      var status = document.getElementById('filter-status').value;
      if(!status) return orders;
      return orders.filter(function(o){return o.status === status;});
    }
    
    function filterOrders() {
      renderOrders(getFilteredOrders());
    }
    
    function batchUpdateStatus() {
      var status = prompt('è¼¸å…¥æ–°ç‹€æ…‹ (pending/processing/shipped/completed/cancelled):');
      if(!status) return;
      
      var promises = selectedIds.map(function(id){
        return fetch('/api/orders/' + id, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({status: status})
        });
      });
      
      Promise.all(promises).then(function(){
        alert('å·²æ›´æ–° ' + selectedIds.length + ' å¼µè¨‚å–®');
        clearSelection();
        location.reload();
      });
    }
    
    function batchDelete() {
      if(!confirm('ç¢ºå®šè¦åˆªé™¤ ' + selectedIds.length + ' å¼µè¨‚å–®å—ï¼Ÿ')) return;
      
      var promises = selectedIds.map(function(id){
        return fetch('/api/orders/' + id, { method: 'DELETE' });
      });
      
      Promise.all(promises).then(function(){
        alert('å·²åˆªé™¤ ' + selectedIds.length + ' å¼µè¨‚å–®');
        clearSelection();
        location.reload();
      });
    }
  </script>
</body>
</html>
