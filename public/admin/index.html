<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #ec4899; --background: #f3f4f6; --surface: #ffffff; --text: #1f2937; --text-muted: #6b7280; --border: #e5e7eb; --success: #10b981; --error: #ef4444; --warning: #f59e0b; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--background); color: var(--text); }
    
    /* Layout */
    .admin-layout { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar { width: 260px; background: var(--text); color: white; padding: 1.5rem 0; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar-header { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { font-size: 1.5rem; font-weight: 700; }
    .logo span { color: var(--secondary); }
    
    .sidebar-nav { padding: 1rem 0; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.2s; cursor: pointer; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
    .nav-item svg { width: 20px; height: 20px; }
    
    /* Main */
    .main { flex: 1; margin-left: 260px; padding: 2rem; }
    
    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .mobile-toggle { display: none; background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    
    .page-title { font-size: 1.75rem; font-weight: 700; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; cursor: pointer; border: none; font-size: 0.9375rem; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-danger { background: var(--error); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border); }
    .stat-label { font-size: 0.875rem; color: var(--text-muted); }
    .stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; }
    .stat-card.warning { border-color: var(--warning); background: #fffbeb; }
    
    /* Table */
    .data-table { background: var(--surface); border-radius: 0.75rem; border: 1px solid var(--border); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--background); font-weight: 600; font-size: 0.875rem; }
    td { font-size: 0.9375rem; }
    tr:hover { background: var(--background); }
    .status { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-completed, .status-active { background: #d1fae5; color: #065f46; }
    .status-cancelled, .status-inactive { background: #fee2e2; color: #991b1b; }
    .status-low-stock { background: #fee2e2; color: #991b1b; }
    .status-out-of-stock { background: #7f1d1d; color: white; }
    
    .action-btn { padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; border: none; margin-right: 0.25rem; }
    .edit-btn { background: var(--primary); color: white; }
    .delete-btn { background: var(--error); color: white; }
    
    /* Tabs */
    .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
    .tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    /* Form */
    .form-container { background: var(--surface); padding: 2rem; border-radius: 0.75rem; border: 1px solid var(--border); }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 0.9375rem; font-family: inherit; transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
    
    /* Toggle Switch */
    .toggle-wrapper { display: flex; align-items: center; gap: 0.75rem; }
    .toggle { position: relative; width: 48px; height: 26px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 26px; cursor: pointer; transition: 0.3s; }
    .toggle-slider:before { content: ''; position: absolute; width: 20px; height: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: var(--primary); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(22px); }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: var(--surface); padding: 2rem; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-close:hover { color: var(--text); }
    .modal-title { font-size: 1.25rem; font-weight: 700; }
    
    /* Variants */
    .variant-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--background); border-radius: 0.5rem; }
    .variant-row input, .variant-row select { flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem; font-size: 0.875rem; }
    .variant-remove { background: var(--error); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .add-variant-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--background); border: 1px dashed var(--border); border-radius: 0.5rem; cursor: pointer; width: 100%; justify-content: center; color: var(--text-muted); }
    .add-variant-btn:hover { border-color: var(--primary); color: var(--primary); }
    
    /* Categories */
    .category-tag { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background: var(--background); border-radius: 0.25rem; font-size: 0.8125rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .category-tag .remove { cursor: pointer; color: var(--error); font-weight: bold; }
    
    /* Badges */
    .badge { padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; }
    .badge-purple { background: #ede9fe; color: #7c3aed; }
    .badge-pink { background: #fce7f3; color: #db2777; }
    
    /* Search */
    .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .search-input { flex: 1; min-width: 200px; padding: 0.625rem 1rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 0.9375rem; }
    .search-input:focus { outline: none; border-color: var(--primary); }
    
    /* Settings */
    .settings-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; }
    .settings-title { font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    
    /* Alerts */
    .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
    .alert-warning { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; }
    .alert-error { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; }
    .alert-success { background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; }
    
    /* Image Preview */
    .image-preview { width: 100px; height: 100px; border-radius: 0.5rem; object-fit: cover; border: 1px solid var(--border); background: var(--background); }
    .image-preview-container { display: flex; align-items: center; gap: 1rem; }
    
    /* Pagination */
    .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1.5rem; }
    .pagination button { padding: 0.5rem 0.75rem; border: 1px solid var(--border); background: var(--surface); border-radius: 0.375rem; cursor: pointer; }
    .pagination button:hover { border-color: var(--primary); color: var(--primary); }
    .pagination button.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* Mobile */
    @media (max-width: 768px) {
      .admin-layout { flex-direction: column; }
      .sidebar { 
        width: 100%; 
        height: auto; 
        position: relative; 
        padding: 1rem 0;
        display: none;
      }
      .sidebar.show { display: block; }
      .mobile-toggle { display: block; }
      .sidebar-nav { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 1rem; }
      .nav-item { padding: 0.5rem 1rem; font-size: 0.875rem; }
      .main { margin-left: 0; padding: 1rem; }
      .page-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .stats-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
      .stat-card { padding: 1rem; }
      .stat-value { font-size: 1.5rem; }
      .data-table { overflow-x: auto; }
      table { min-width: 700px; }
      .form-container { padding: 1rem; }
      .modal-content { padding: 1rem; }
      .form-row { grid-template-columns: 1fr; }
      .search-bar { flex-direction: column; }
      .search-input { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">OHYA<span>2.0</span> Admin</div>
      </div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="showPage('dashboard')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
          Dashboard
        </a>
        <a href="#" class="nav-item" onclick="showPage('products')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          ç”¢å“ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('categories')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          åˆ†é¡ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('inventory')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
          åº«å­˜ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('orders')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
          è¨‚å–®ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('import')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          åŒ¯å…¥/åŒ¯å‡º
        </a>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          è¿”å›ç¶²ç«™
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="page-header">
        <button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('show')">â˜° Menu</button>
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <div class="user-info">
          <span>Admin</span>
          <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½ç”¢å“æ•¸</div>
            <div class="stat-value" id="stat-products">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            <div class="stat-value" id="stat-orders">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å¾…è™•ç†è¨‚å–®</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-label">ä½åº«å­˜ç”¢å“</div>
            <div class="stat-value" id="stat-low-stock" style="color: var(--warning);">-</div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 1rem;">æœ€æ–°è¨‚å–®</h3>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ—¥æœŸ</th></tr>
            </thead>
            <tbody id="recent-orders"></tbody>
          </table>
        </div>
      </div>

      <!-- Products Page -->
      <div id="page-products" style="display:none;">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="æœå°‹ç”¢å“..." id="product-search" oninput="filterProducts()">
          <select class="search-input" style="max-width: 180px;" id="category-filter" onchange="filterProducts()">
            <option value="">æ‰€æœ‰åˆ†é¡</option>
          </select>
          <select class="search-input" style="max-width: 150px;" id="status-filter" onchange="filterProducts()">
            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
            <option value="active">ä¸Šæ¶ä¸­</option>
            <option value="inactive">å·²ä¸‹æ¶</option>
          </select>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div class="tabs" style="margin-bottom: 0;">
            <div class="tab active">å…¨éƒ¨ç”¢å“</div>
          </div>
          <button class="btn btn-primary" onclick="openProductModal()">â• æ–°å¢ç”¢å“</button>
        </div>
        
        <div id="low-stock-alert"></div>
        
        <div class="data-table">
          <table>
            <thead>
              <tr><th>ç·¨ç¢¼</th><th>åç¨±</th><th>åˆ†é¡</th><th>åƒ¹æ ¼</th><th>æ¯”è¼ƒåƒ¹</th><th>åº«å­˜</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="product-list"></tbody>
          </table>
        </div>
        <div class="pagination" id="product-pagination"></div>
      </div>

      <!-- Categories Page -->
      <div id="page-categories" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2>åˆ†é¡ç®¡ç†</h2>
          <button class="btn btn-primary" onclick="openCategoryModal()">â• æ–°å¢åˆ†é¡</button>
        </div>
        
        <div class="data-table">
          <table>
            <thead>
              <tr><th>åˆ†é¡åç¨±</th><th>ç”¢å“æ•¸é‡</th><th>å»ºç«‹æ—¥æœŸ</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="category-list"></tbody>
          </table>
        </div>
      </div>

      <!-- Inventory Page -->
      <div id="page-inventory" style="display:none;">
        <div class="settings-card">
          <div class="settings-title">
            âš™ï¸ åº«å­˜è¨­å®š
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ä½åº«å­˜è­¦å‘Šé–¾å€¼</label>
              <input type="number" id="low-stock-threshold" value="10" min="1" onchange="saveSettings()">
              <div class="form-hint">ç•¶åº«å­˜ä½æ–¼æ­¤æ•¸é‡æ™‚é¡¯ç¤ºè­¦å‘Š</div>
            </div>
            <div class="form-group">
              <label>ç¼ºè²¨é–¾å€¼</label>
              <input type="number" id="out-of-stock-threshold" value="0" min="0" onchange="saveSettings()">
              <div class="form-hint">ç•¶åº«å­˜ç­‰æ–¼æˆ–ä½æ–¼æ­¤æ•¸é‡æ™‚è¦–ç‚ºç¼ºè²¨</div>
            </div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 1rem;">åº«å­˜æ¦‚è¦½</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½åº«å­˜ç”¢å“</div>
            <div class="stat-value" id="inv-total">-</div>
          </div>
          <div class="stat-card" style="border-color: var(--warning);">
            <div class="stat-label">ä½åº«å­˜</div>
            <div class="stat-value" id="inv-low" style="color: var(--warning);">-</div>
          </div>
          <div class="stat-card" style="border-color: var(--error);">
            <div class="stat-label">ç¼ºè²¨</div>
            <div class="stat-value" id="inv-out" style="color: var(--error);">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½åº«å­˜åƒ¹å€¼</div>
            <div class="stat-value" id="inv-value">-</div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 1rem;">åº«å­˜ä¸è¶³çš„ç”¢å“</h3>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>ç”¢å“</th><th>ç•¶å‰åº«å­˜</th><th>é–¾å€¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="inventory-list"></tbody>
          </table>
        </div>
      </div>

      <!-- Orders Page -->
      <div id="page-orders" style="display:none;">
        <div class="tabs">
          <div class="tab active" onclick="filterOrders('all')">å…¨éƒ¨</div>
          <div class="tab" onclick="filterOrders('pending')">å¾…è™•ç†</div>
          <div class="tab" onclick="filterOrders('completed')">å·²å®Œæˆ</div>
        </div>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>ç”¢å“</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="order-list"></tbody>
          </table>
        </div>
      </div>

      <!-- Import/Export Page -->
      <div id="page-import" style="display:none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
          <div class="form-container">
            <h3 style="margin-bottom: 1rem;">ğŸ“¥ åŒ¯å…¥ç”¢å“ (CSV)</h3>
            <div class="form-group">
              <label>é¸æ“‡CSVæª”æ¡ˆ</label>
              <input type="file" accept=".csv" id="import-file">
            </div>
            <button class="btn btn-primary" onclick="importProducts()">åŒ¯å…¥</button>
          </div>
          <div class="form-container">
            <h3 style="margin-bottom: 1rem;">ğŸ“¤ åŒ¯å‡ºç”¢å“ (CSV)</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">åŒ¯å‡ºæ‰€æœ‰ç”¢å“è³‡æ–™ç‚ºCSVæª”æ¡ˆ</p>
            <button class="btn btn-primary" onclick="exportProducts()">åŒ¯å‡ºCSV</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">æ–°å¢ç”¢å“</h2>
        <button class="modal-close" onclick="closeModal('product-modal')">&times;</button>
      </div>
      <form id="product-form" onsubmit="saveProduct(event)">
        <input type="hidden" id="p-id">
        
        <div class="form-row">
          <div class="form-group">
            <label>ç”¢å“ç·¨ç¢¼ *</label>
            <input type="text" id="p-code" required placeholder="ä¾‹å¦‚: OHYA-001">
          </div>
          <div class="form-group">
            <label>æ¢ç¢¼</label>
            <input type="text" id="p-barcode" placeholder="EAN/UPCæ¢ç¢¼">
          </div>
        </div>
        
        <div class="form-group">
          <label>ç”¢å“åç¨± *</label>
          <input type="text" id="p-name" required placeholder="ç”¢å“åç¨±">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>åƒ¹æ ¼ *</label>
            <input type="number" id="p-price" required min="0" step="1" placeholder="0">
          </div>
          <div class="form-group">
            <label>æ¯”è¼ƒåƒ¹æ ¼ (åŸåƒ¹)</label>
            <input type="number" id="p-compare-price" min="0" step="1" placeholder="0">
            <div class="form-hint">é¡¯ç¤ºç‚ºæŠ˜æ‰£å‰çš„åƒ¹æ ¼</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>ç”¢å“æè¿°</label>
          <textarea id="p-desc" rows="4" placeholder="ç”¢å“æè¿°..."></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>åˆ†é¡</label>
            <select id="p-category">
              <option value="">é¸æ“‡åˆ†é¡</option>
            </select>
          </div>
          <div class="form-group">
            <label>åœ–ç‰‡URL</label>
            <input type="url" id="p-image" placeholder="https://...">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>åº«å­˜æ•¸é‡</label>
            <input type="number" id="p-stock" value="0" min="0">
          </div>
          <div class="form-group">
            <label>åº«å­˜è¿½è¹¤</label>
            <div class="toggle-wrapper">
              <label class="toggle">
                <input type="checkbox" id="p-track-stock" checked>
                <span class="toggle-slider"></span>
              </label>
              <span>å•Ÿç”¨åº«å­˜è¿½è¹¤</span>
            </div>
          </div>
        </div>
        
        <!-- Product Variants -->
        <div class="form-group">
          <label>ç”¢å“è®Šé«” (é¡è‰²/å°ºå¯¸)</label>
          <div id="variant-container">
            <div class="variant-row">
              <select class="variant-type" style="max-width: 100px;">
                <option value="size">å°ºå¯¸</option>
                <option value="color">é¡è‰²</option>
              </select>
              <input type="text" class="variant-value" placeholder="ä¾‹å¦‚: S, M, L æˆ– ç´…è‰², è—è‰²">
              <input type="number" class="variant-stock" placeholder="åº«å­˜" min="0" value="0">
              <button type="button" class="variant-remove" onclick="removeVariant(this)">Ã—</button>
            </div>
          </div>
          <button type="button" class="add-variant-btn" onclick="addVariant()">+ æ·»åŠ è®Šé«”</button>
        </div>
        
        <div class="form-group">
          <div class="toggle-wrapper">
            <label class="toggle">
              <input type="checkbox" id="p-active" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>ç”¢å“ç‹€æ…‹: <strong id="p-active-label">ä¸Šæ¶ä¸­</strong></span>
          </div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button type="submit" class="btn btn-primary">å„²å­˜ç”¢å“</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('product-modal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Modal -->
  <div class="modal" id="category-modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title" id="category-modal-title">æ–°å¢åˆ†é¡</h2>
        <button class="modal-close" onclick="closeModal('category-modal')">&times;</button>
      </div>
      <form onsubmit="saveCategory(event)">
        <input type="hidden" id="c-id">
        <div class="form-group">
          <label>åˆ†é¡åç¨± *</label>
          <input type="text" id="c-name" required placeholder="åˆ†é¡åç¨±">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary">å„²å­˜</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('category-modal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Stock Update Modal -->
  <div class="modal" id="stock-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">æ›´æ–°åº«å­˜</h2>
        <button class="modal-close" onclick="closeModal('stock-modal')">&times;</button>
      </div>
      <form onsubmit="updateStock(event)">
        <input type="hidden" id="stock-p-id">
        <div class="form-group">
          <label>ç”¢å“</label>
          <div id="stock-p-name" style="font-weight: 600; padding: 0.5rem; background: var(--background); border-radius: 0.5rem;"></div>
        </div>
        <div class="form-group">
          <label>ç•¶å‰åº«å­˜</label>
          <div id="stock-current" style="font-weight: 600; color: var(--primary);"></div>
        </div>
        <div class="form-group">
          <label>èª¿æ•´æ•¸é‡</label>
          <input type="number" id="stock-adjust" value="0" placeholder="è¼¸å…¥æ­£æ•¸å¢åŠ ï¼Œè² æ•¸æ¸›å°‘">
          <div class="form-hint">ä¾‹å¦‚: +10 å¢åŠ åº«å­˜, -5 æ¸›å°‘åº«å­˜</div>
        </div>
        <div class="form-group">
          <label>æ–°åº«å­˜æ•¸é‡</label>
          <div id="stock-new" style="font-weight: 600; color: var(--success);"></div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary">æ›´æ–°åº«å­˜</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('stock-modal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Data
    let products = [];
    let categories = [];
    let orders = [];
    let settings = {
      lowStockThreshold: 10,
      outOfStockThreshold: 0
    };
    
    // Pagination
    let currentPage = 1;
    const itemsPerPage = 15;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSettings();
      await loadCategories();
      await loadData();
      updateCategoryFilters();
      
      // Toggle label update
      document.getElementById('p-active').addEventListener('change', function() {
        document.getElementById('p-active-label').textContent = this.checked ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶';
      });
      
      // Stock adjustment preview
      document.getElementById('stock-adjust').addEventListener('input', updateStockPreview);
    });
    
    async function loadSettings() {
      try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (data.lowStockThreshold) settings.lowStockThreshold = data.lowStockThreshold;
        if (data.outOfStockThreshold !== undefined) settings.outOfStockThreshold = data.outOfStockThreshold;
      } catch(e) { console.log('Using default settings'); }
      
      document.getElementById('low-stock-threshold').value = settings.lowStockThreshold;
      document.getElementById('out-of-stock-threshold').value = settings.outOfStockThreshold;
    }
    
    async function saveSettings() {
      settings.lowStockThreshold = parseInt(document.getElementById('low-stock-threshold').value);
      settings.outOfStockThreshold = parseInt(document.getElementById('out-of-stock-threshold').value);
      
      try {
        await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
      } catch(e) { console.log('Settings saved locally'); }
      
      renderProducts();
      renderInventory();
    }
    
    async function loadData() {
      try {
        const pRes = await fetch('/api/products');
        products = await pRes.json();
        renderProducts();
      } catch(e) { 
        products = getSampleProducts();
        renderProducts();
      }
      
      try {
        const oRes = await fetch('/api/orders');
        orders = await oRes.json();
      } catch(e) { 
        orders = getSampleOrders();
      }
      renderOrders();
      
      // Update stats
      document.getElementById('stat-products').textContent = products.length;
      document.getElementById('stat-orders').textContent = orders.length;
      document.getElementById('stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
      
      const lowStock = products.filter(p => p.stock <= settings.lowStockThreshold && p.stock > settings.outOfStockThreshold).length;
      const outOfStock = products.filter(p => p.stock <= settings.outOfStockThreshold).length;
      document.getElementById('stat-low-stock').textContent = lowStock + outOfStock;
      
      renderCategories();
      renderInventory();
    }
    
    function getSampleProducts() {
      return [
        { id: 1, product_code: 'OHYA-001', name: 'Premium Plus', price: 4980, compare_price: 5980, description: 'é ‚ç´šç”¢å“', category: 'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«', stock: 25, active: true, barcode: '123456789', image: '', track_stock: true, variants: [] },
        { id: 2, product_code: 'OHYA-002', name: 'Classic Edition', price: 3980, compare_price: 0, description: 'ç¶“å…¸æ¬¾å¼', category: 'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«', stock: 8, active: true, barcode: '123456790', image: '', track_stock: true, variants: [] },
        { id: 3, product_code: 'OHYA-003', name: 'Realistic Lite', price: 6980, compare_price: 7980, description: 'ä»¿çœŸç‰ˆæœ¬', category: 'ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•', stock: 0, active: true, barcode: '123456791', image: '', track_stock: true, variants: [] },
        { id: 4, product_code: 'OHYA-004', name: 'Silky Touch', price: 2980, compare_price: 0, description: 'çµ²æ»‘è§¸æ„Ÿ', category: 'ãŠã£ã±ã„ã‚°ãƒƒã‚º', stock: 15, active: true, barcode: '', image: '', track_stock: true, variants: [] }
      ];
    }
    
    function getSampleOrders() {
      return [
        { id: 1001, user_name: 'æ¸¬è©¦ç”¨æˆ¶', user_id: 1, total: 'Â¥4980', status: 'pending', created_at: new Date().toISOString() },
        { id: 1002, user_name: 'å¼µä¸‰', user_id: 2, total: 'Â¥6980', status: 'completed', created_at: new Date(Date.now() - 86400000).toISOString() }
      ];
    }
    
    // Categories
    const defaultCategories = ['ã‚ªãƒŠãƒ›ãƒ¼ãƒ«', 'ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•', 'ãŠã£ã±ã„ã‚°ãƒƒã‚º', 'ãƒ¬ã‚¶ãƒ¼ãƒ»ãƒ”ã‚¹ãƒ”ãƒ¼ã‚¯', 'å…¶ä»–'];
    
    async function loadCategories() {
      try {
        const res = await fetch('/api/categories');
        categories = await res.json();
      } catch(e) {
        categories = defaultCategories.map((name, i) => ({ id: i + 1, name, created_at: new Date().toISOString() }));
      }
    }
    
    function renderCategories() {
      const tbody = document.getElementById('category-list');
      tbody.innerHTML = categories.map(c => {
        const count = products.filter(p => p.category === c.name).length;
        return `
          <tr>
            <td><strong>${c.name}</strong></td>
            <td><span class="badge badge-purple">${count} é …ç”¢å“</span></td>
            <td>${new Date(c.created_at || Date.now()).toLocaleDateString()}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editCategory(${c.id})">ç·¨è¼¯</button>
              <button class="action-btn delete-btn" onclick="deleteCategory(${c.id})">åˆªé™¤</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function updateCategoryFilters() {
      const filters = ['category-filter', 'p-category'];
      filters.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = id === 'category-filter' ? '<option value="">æ‰€æœ‰åˆ†é¡</option>' : '<option value="">é¸æ“‡åˆ†é¡</option>';
        categories.forEach(c => {
          select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
        });
      });
    }
    
    function openCategoryModal(id = null) {
      document.getElementById('category-modal-title').textContent = id ? 'ç·¨è¼¯åˆ†é¡' : 'æ–°å¢åˆ†é¡';
      document.getElementById('c-id').value = id || '';
      if (id) {
        const cat = categories.find(c => c.id === id);
        document.getElementById('c-name').value = cat.name;
      } else {
        document.getElementById('c-name').value = '';
      }
      showModal('category-modal');
    }
    
    function editCategory(id) {
      openCategoryModal(id);
    }
    
    async function deleteCategory(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿ')) return;
      categories = categories.filter(c => c.id !== id);
      renderCategories();
      updateCategoryFilters();
    }
    
    async function saveCategory(e) {
      e.preventDefault();
      const id = document.getElementById('c-id').value;
      const name = document.getElementById('c-name').value;
      
      if (id) {
        const cat = categories.find(c => c.id === parseInt(id));
        cat.name = name;
      } else {
        categories.push({ id: Date.now(), name, created_at: new Date().toISOString() });
      }
      
      renderCategories();
      updateCategoryFilters();
      closeModal('category-modal');
    }
    
    // Products
    function filterProducts() {
      const search = document.getElementById('product-search').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      const status = document.getElementById('status-filter').value;
      
      let filtered = products.filter(p => {
        const matchSearch = !search || p.name.toLowerCase().includes(search) || (p.product_code || '').toLowerCase().includes(search);
        const matchCategory = !category || p.category === category;
        const matchStatus = !status || (status === 'active' && p.active) || (status === 'inactive' && !p.active);
        return matchSearch && matchCategory && matchStatus;
      });
      
      renderProductList(filtered);
    }
    
    function renderProducts() {
      filterProducts();
      checkLowStock();
    }
    
    function renderProductList(list) {
      const start = (currentPage - 1) * itemsPerPage;
      const paginated = list.slice(start, start + itemsPerPage);
      
      const tbody = document.getElementById('product-list');
      tbody.innerHTML = paginated.map(p => {
        let stockStatus = 'status-active';
        let statusText = 'ä¸Šæ¶';
        if (p.stock <= settings.outOfStockThreshold) {
          stockStatus = 'status-out-of-stock';
          statusText = 'ç¼ºè²¨';
        } else if (p.stock <= settings.lowStockThreshold) {
          stockStatus = 'status-low-stock';
          statusText = 'ä½åº«å­˜';
        }
        
        const variantCount = p.variants ? p.variants.length : 0;
        
        return `
          <tr>
            <td><code>${p.product_code || '-'}</code></td>
            <td>
              <strong>${p.name || '-'}</strong>
              ${variantCount > 0 ? `<br><span class="badge badge-pink">${variantCount} è®Šé«”</span>` : ''}
            </td>
            <td>${p.category || '-'}</td>
            <td>Â¥${p.price || 0}</td>
            <td>${p.compare_price > 0 ? `<span style="text-decoration: line-through; color: var(--text-muted);">Â¥${p.compare_price}</span>` : '-'}</td>
            <td>
              <span class="${stockStatus}">${p.stock || 0}</span>
              ${p.track_stock ? '' : '<br><span class="form-hint">ä¸è¿½è¹¤</span>'}
            </td>
            <td><span class="status ${p.active ? 'status-active' : 'status-inactive'}">${p.active ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}</span></td>
            <td>
              <button class="action-btn edit-btn" onclick="editProduct(${p.id})">ç·¨è¼¯</button>
              <button class="action-btn delete-btn" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Pagination
      const totalPages = Math.ceil(list.length / itemsPerPage);
      let paginationHtml = '';
      for (let i = 1; i <= totalPages; i++) {
        paginationHtml += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }
      document.getElementById('product-pagination').innerHTML = paginationHtml;
    }
    
    function goToPage(page) {
      currentPage = page;
      filterProducts();
    }
    
    function checkLowStock() {
      const lowStockProducts = products.filter(p => p.stock <= settings.lowStockThreshold && p.stock > settings.outOfStockThreshold);
      const outOfStockProducts = products.filter(p => p.stock <= settings.outOfStockThreshold);
      
      const alertDiv = document.getElementById('low-stock-alert');
      if (lowStockProducts.length > 0 || outOfStockProducts.length > 0) {
        alertDiv.innerHTML = `
          <div class="alert ${outOfStockProducts.length > 0 ? 'alert-error' : 'alert-warning'}">
            <span>âš ï¸ ${outOfStockProducts.length > 0 ? `${outOfStockProducts.length} é …ç”¢å“ç¼ºè²¨ï¼Œ` : ''}${lowStockProducts.length} é …ç”¢å“åº«å­˜ä¸è¶³</span>
            <button class="btn btn-sm btn-warning" onclick="showPage('inventory')">æŸ¥çœ‹åº«å­˜</button>
          </div>
        `;
      } else {
        alertDiv.innerHTML = '';
      }
    }
    
    function openProductModal(id = null) {
      document.getElementById('product-modal-title').textContent = id ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“';
      document.getElementById('product-form').reset();
      document.getElementById('p-id').value = id || '';
      document.getElementById('p-track-stock').checked = true;
      document.getElementById('p-active').checked = true;
      document.getElementById('p-active-label').textContent = 'ä¸Šæ¶ä¸­';
      document.getElementById('p-stock').value = 0;
      
      // Reset variants
      document.getElementById('variant-container').innerHTML = `
        <div class="variant-row">
          <select class="variant-type" style="max-width: 100px;">
            <option value="size">å°ºå¯¸</option>
            <option value="color">é¡è‰²</option>
          </select>
          <input type="text" class="variant-value" placeholder="ä¾‹å¦‚: S, M, L æˆ– ç´…è‰², è—è‰²">
          <input type="number" class="variant-stock" placeholder="åº«å­˜" min="0" value="0">
          <button type="button" class="variant-remove" onclick="removeVariant(this)">Ã—</button>
        </div>
      `;
      
      if (id) {
        const p = products.find(prod => prod.id === id);
        document.getElementById('p-code').value = p.product_code || '';
        document.getElementById('p-barcode').value = p.barcode || '';
        document.getElementById('p-name').value = p.name || '';
        document.getElementById('p-price').value = p.price || 0;
        document.getElementById('p-compare-price').value = p.compare_price || 0;
        document.getElementById('p-desc').value = p.description || '';
        document.getElementById('p-category').value = p.category || '';
        document.getElementById('p-image').value = p.image || '';
        document.getElementById('p-stock').value = p.stock || 0;
        document.getElementById('p-track-stock').checked = p.track_stock !== false;
        document.getElementById('p-active').checked = p.active !== false;
        document.getElementById('p-active-label').textContent = p.active ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶';
        
        // Variants
        if (p.variants && p.variants.length > 0) {
          let variantsHtml = '';
          p.variants.forEach(v => {
            variantsHtml += `
              <div class="variant-row">
                <select class="variant-type" style="max-width: 100px;">
                  <option value="${v.type}" ${v.type === 'size' ? 'selected' : ''}>å°ºå¯¸</option>
                  <option value="${v.type}" ${v.type === 'color' ? 'selected' : ''}>é¡è‰²</option>
                </select>
                <input type="text" class="variant-value" placeholder="ä¾‹å¦‚: S, M, L æˆ– ç´…è‰², è—è‰²" value="${v.value}">
                <input type="number" class="variant-stock" placeholder="åº«å­˜" min="0" value="${v.stock || 0}">
                <button type="button" class="variant-remove" onclick="removeVariant(this)">Ã—</button>
              </div>
            `;
          });
          document.getElementById('variant-container').innerHTML = variantsHtml;
        }
      }
      
      showModal('product-modal');
    }
    
    function editProduct(id) {
      openProductModal(id);
    }
    
    async function saveProduct(e) {
      e.preventDefault();
      
      const id = document.getElementById('p-id').value;
      
      // Collect variants
      const variantRows = document.querySelectorAll('#variant-container .variant-row');
      const variants = [];
      variantRows.forEach(row => {
        const type = row.querySelector('.variant-type').value;
        const value = row.querySelector('.variant-value').value;
        const stock = parseInt(row.querySelector('.variant-stock').value) || 0;
        if (value) {
          variants.push({ type, value, stock });
        }
      });
      
      const productData = {
        product_code: document.getElementById('p-code').value,
        barcode: document.getElementById('p-barcode').value,
        name: document.getElementById('p-name').value,
        price: parseInt(document.getElementById('p-price').value) || 0,
        compare_price: parseInt(document.getElementById('p-compare-price').value) || 0,
        description: document.getElementById('p-desc').value,
        category: document.getElementById('p-category').value,
        image: document.getElementById('p-image').value,
        stock: parseInt(document.getElementById('p-stock').value) || 0,
        track_stock: document.getElementById('p-track-stock').checked,
        active: document.getElementById('p-active').checked,
        variants: variants
      };
      
      if (id) {
        const idx = products.findIndex(p => p.id === parseInt(id));
        products[idx] = { ...products[idx], ...productData };
      } else {
        productData.id = Date.now();
        products.push(productData);
      }
      
      renderProducts();
      renderInventory();
      closeModal('product-modal');
    }
    
    async function deleteProduct(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿ')) return;
      products = products.filter(p => p.id !== id);
      renderProducts();
      renderInventory();
    }
    
    function addVariant() {
      const container = document.getElementById('variant-container');
      const div = document.createElement('div');
      div.className = 'variant-row';
      div.innerHTML = `
        <select class="variant-type" style="max-width: 100px;">
          <option value="size">å°ºå¯¸</option>
          <option value="color">é¡è‰²</option>
        </select>
        <input type="text" class="variant-value" placeholder="ä¾‹å¦‚: S, M, L æˆ– ç´…è‰², è—è‰²">
        <input type="number" class="variant-stock" placeholder="åº«å­˜" min="0" value="0">
        <button type="button" class="variant-remove" onclick="removeVariant(this)">Ã—</button>
      `;
      container.appendChild(div);
    }
    
    function removeVariant(btn) {
      const rows = document.querySelectorAll('#variant-container .variant-row');
      if (rows.length > 1) {
        btn.parentElement.remove();
      }
    }
    
    // Inventory
    function renderInventory() {
      const lowStock = products.filter(p => p.stock <= settings.lowStockThreshold && p.stock > settings.outOfStockThreshold);
      const outOfStock = products.filter(p => p.stock <= settings.outOfStockThreshold);
      const totalValue = products.reduce((sum, p) => sum + (p.price * (p.stock || 0)), 0);
      
      document.getElementById('inv-total').textContent = products.length;
      document.getElementById('inv-low').textContent = lowStock.length;
      document.getElementById('inv-out').textContent = outOfStock.length;
      document.getElementById('inv-value').textContent = 'Â¥' + totalValue.toLocaleString();
      
      const tbody = document.getElementById('inventory-list');
      const allIssues = [...outOfStock, ...lowStock].sort((a, b) => a.stock - b.stock);
      
      tbody.innerHTML = allIssues.map(p => {
        const isOutOfStock = p.stock <= settings.outOfStockThreshold;
        return `
          <tr>
            <td><strong>${p.name}</strong><br><code>${p.product_code}</code></td>
            <td><strong style="color: ${isOutOfStock ? 'var(--error)' : 'var(--warning)'}">${p.stock}</strong></td>
            <td>${settings.lowStockThreshold}</td>
            <td><span class="status ${isOutOfStock ? 'status-out-of-stock' : 'status-low-stock'}">${isOutOfStock ? 'ç¼ºè²¨' : 'ä½åº«å­˜'}</span></td>
            <td>
              <button class="action-btn edit-btn" onclick="openStockModal(${p.id})">æ›´æ–°åº«å­˜</button>
              <button class="action-btn edit-btn" onclick="editProduct(${p.id})">ç·¨è¼¯ç”¢å“</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function openStockModal(id) {
      const p = products.find(prod => prod.id === id);
      document.getElementById('stock-p-id').value = id;
      document.getElementById('stock-p-name').textContent = p.name;
      document.getElementById('stock-current').textContent = p.stock;
      document.getElementById('stock-adjust').value = 0;
      document.getElementById('stock-new').textContent = p.stock;
      showModal('stock-modal');
    }
    
    function updateStockPreview() {
      const current = parseInt(document.getElementById('stock-current').textContent);
      const adjust = parseInt(document.getElementById('stock-adjust').value) || 0;
      const newStock = Math.max(0, current + adjust);
      document.getElementById('stock-new').textContent = newStock;
    }
    
    function updateStock(e) {
      e.preventDefault();
      const id = parseInt(document.getElementById('stock-p-id').value);
      const adjust = parseInt(document.getElementById('stock-adjust').value) || 0;
      
      const p = products.find(prod => prod.id === id);
      p.stock = Math.max(0, p.stock + adjust);
      
      renderProducts();
      renderInventory();
      closeModal('stock-modal');
    }
    
    // Orders
    function filterOrders(status) {
      document.querySelectorAll('#page-orders .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      let filtered = orders;
      if (status !== 'all') {
        filtered = orders.filter(o => o.status === status);
      }
      
      const tbody = document.getElementById('order-list');
      tbody.innerHTML = filtered.slice(0, 20).map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${o.user_name || 'User ' + o.user_id}</td>
          <td>${o.items || '-'}</td>
          <td>${o.total}</td>
          <td><span class="status status-${o.status}">${o.status === 'pending' ? 'å¾…è™•ç†' : o.status === 'completed' ? 'å·²å®Œæˆ' : o.status}</span></td>
          <td>
            <button class="action-btn edit-btn" onclick="updateOrderStatus(${o.id})">æ›´æ–°ç‹€æ…‹</button>
          </td>
        </tr>
      `).join('');
    }
    
    function renderOrders() {
      filterOrders('all');
      
      // Recent orders
      document.getElementById('recent-orders').innerHTML = orders.slice(0, 5).map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${o.user_name || 'User ' + o.user_id}</td>
          <td>${o.total}</td>
          <td><span class="status status-${o.status}">${o.status === 'pending' ? 'å¾…è™•ç†' : o.status === 'completed' ? 'å·²å®Œæˆ' : o.status}</span></td>
          <td>${new Date(o.created_at).toLocaleDateString()}</td>
        </tr>
      `).join('');
    }
    
    function updateOrderStatus(id) {
      // Simple status toggle for demo
      const order = orders.find(o => o.id === id);
      if (order.status === 'pending') {
        order.status = 'completed';
        // Auto-deduct stock when order completes
        deductStock(order);
      } else {
        order.status = 'pending';
      }
      renderOrders();
      renderInventory();
    }
    
    function deductStock(order) {
      // In real app, this would be more sophisticated
      console.log('Stock deducted for order #' + order.id);
    }
    
    // Navigation
    function showPage(page) {
      document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
      document.getElementById('page-' + page).style.display = 'block';
      
      const titles = {
        dashboard: 'Dashboard',
        products: 'ç”¢å“ç®¡ç†',
        categories: 'åˆ†é¡ç®¡ç†',
        inventory: 'åº«å­˜ç®¡ç†',
        orders: 'è¨‚å–®ç®¡ç†',
        import: 'åŒ¯å…¥/åŒ¯å‡º'
      };
      document.getElementById('page-title').textContent = titles[page] || page;
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event?.target?.classList?.add('active');
      
      // Reset pagination
      currentPage = 1;
    }
    
    // Modal helpers
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // Import/Export
    async function exportProducts() {
      window.location.href = '/api/products/export';
    }
    
    async function importProducts() {
      const file = document.getElementById('import-file').files[0];
      if (!file) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const res = await fetch('/api/products/import', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          alert('åŒ¯å…¥æˆåŠŸï¼' + data.imported + ' é …ç”¢å“');
          loadData();
        } else {
          alert('åŒ¯å…¥å¤±æ•—');
        }
      } catch(e) {
        alert('åŒ¯å…¥åŠŸèƒ½éœ€è¦å¾Œç«¯æ”¯æ´');
      }
    }
    
    function logout() { location.href = '/'; }
  </script>
</body>
</html>
