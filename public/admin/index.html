<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #ec4899; --background: #f3f4f6; --surface: #ffffff; --text: #1f2937; --text-muted: #6b7280; --border: #e5e7eb; --success: #10b981; --error: #ef4444; --warning: #f59e0b; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--background); color: var(--text); }
    .admin-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--text); color: white; padding: 1.5rem 0; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar-header { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { font-size: 1.5rem; font-weight: 700; }
    .logo span { color: var(--secondary); }
    .sidebar-nav { padding: 1rem 0; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.2s; cursor: pointer; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
    .nav-item svg { width: 20px; height: 20px; }
    .main { flex: 1; margin-left: 260px; padding: 2rem; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .page-title { font-size: 1.75rem; font-weight: 700; }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; cursor: pointer; border: none; font-size: 0.9375rem; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-danger { background: var(--error); color: white; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border); }
    .stat-label { font-size: 0.875rem; color: var(--text-muted); }
    .stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; }
    .data-table { background: var(--surface); border-radius: 0.75rem; border: 1px solid var(--border); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--background); font-weight: 600; font-size: 0.875rem; }
    .status { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .form-container { background: var(--surface); padding: 2rem; border-radius: 0.75rem; border: 1px solid var(--border); max-width: 600px; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: var(--surface); padding: 2rem; border-radius: 1rem; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
    .tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--text-muted); cursor: pointer; }
    .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); margin-bottom: -2px; }
    @media (max-width: 768px) {
      .admin-layout { flex-direction: column; }
      .sidebar { width: 100%; height: auto; position: relative; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header"><div class="logo">OHYA<span>2.0</span> Admin</div></div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="showPage('dashboard')">ğŸ“Š Dashboard</a>
        <a href="#" class="nav-item" onclick="showPage('products')">ğŸ“¦ ç”¢å“ç®¡ç†</a>
        <a href="#" class="nav-item" onclick="showPage('categories')">ğŸ·ï¸ åˆ†é¡ç®¡ç†</a>
        <a href="#" class="nav-item" onclick="showPage('orders')">ğŸ›’ è¨‚å–®ç®¡ç†</a>
        <a href="#" class="nav-item" onclick="showPage('customers')">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</a>
        <a href="#" class="nav-item" onclick="showPage('marketing')">ğŸŸï¸ ç‡ŸéŠ·æ¨å»£</a>
        <a href="#" class="nav-item" onclick="showPage('analytics')">ğŸ“ˆ æ•¸æ“šåˆ†æ</a>
        <a href="#" class="nav-item" onclick="showPage('settings')">âš™ï¸ ç³»çµ±è¨­å®š</a>
        <a href="#" class="nav-item" onclick="showPage('import')">ğŸ“¥ åŒ¯å…¥/åŒ¯å‡º</a>
        <a href="/" class="nav-item">ğŸ  è¿”å›ç¶²ç«™</a>
      </nav>
    </aside>
    <main class="main">
      <div class="page-header">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
      </div>
      <div id="page-content"></div>
    </main>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ç”¢å“è³‡æ–™</h2>
        <button class="modal-close" onclick="closeModal('product-modal')">&times;</button>
      </div>
      <form id="product-form">
        <input type="hidden" id="p-id">
        <div class="form-group">
          <label>ç”¢å“ç·¨ç¢¼</label>
          <input type="text" id="p-code" required>
        </div>
        <div class="form-group">
          <label>ç”¢å“åç¨±</label>
          <input type="text" id="p-name" required>
        </div>
        <div class="form-group">
          <label>åƒ¹æ ¼</label>
          <input type="number" id="p-price" required>
        </div>
        <div class="form-group">
          <label>åº«å­˜</label>
          <input type="number" id="p-stock">
        </div>
        <div class="form-group">
          <label>åˆ†é¡</label>
          <select id="p-category">
            <option value="ã‚ªãƒŠãƒ›ãƒ¼ãƒ«">ã‚ªãƒŠãƒ›ãƒ¼ãƒ«</option>
            <option value="ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•">ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•</option>
            <option value="ãŠã£ã±ã„ã‚°ãƒƒã‚º">ãŠã£ã±ã„ã‚°ãƒƒã‚º</option>
            <option value="æ€§æ„Ÿã‚¯ãƒƒã‚·ãƒ§ãƒ³">æ€§æ„Ÿã‚¯ãƒƒã‚·ãƒ§ãƒ³</option>
          </select>
        </div>
        <div class="form-group">
          <label>åœ–ç‰‡ URL</label>
          <input type="text" id="p-image">
        </div>
        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="p-desc" rows="4"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">å„²å­˜</button>
      </form>
    </div>
  </div>

  <script>
    let products = [];
    let orders = [];
    let customers = [];
    let coupons = [];
    let currentPage = 'dashboard';

    async function loadData() {
      try {
        const [pRes, oRes, cRes] = await Promise.all([
          fetch('/api/products'),
          fetch('/api/orders'),
          fetch('/api/customers')
        ]);
        products = await pRes.json();
        orders = await oRes.json();
        customers = await cRes.json();
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }

    async function showPage(page) {
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if (event) event.target.classList.add('active');
      const content = document.getElementById('page-content');
      document.getElementById('page-title').textContent = {
        dashboard: 'Dashboard', products: 'ç”¢å“ç®¡ç†', categories: 'åˆ†é¡ç®¡ç†',
        orders: 'è¨‚å–®ç®¡ç†', customers: 'å®¢æˆ¶ç®¡ç†', marketing: 'ç‡ŸéŠ·æ¨å»£',
        analytics: 'æ•¸æ“šåˆ†æ', settings: 'ç³»çµ±è¨­å®š', import: 'åŒ¯å…¥/åŒ¯å‡º'
      }[page] || page;
      
      await loadData();

      if (page === 'dashboard') renderDashboard();
      else if (page === 'products') renderProducts();
      else if (page === 'orders') renderOrders();
      else if (page === 'customers') renderCustomers();
      else if (page === 'marketing') renderMarketing();
      else if (page === 'settings') renderSettings();
      else if (page === 'import') renderImport();
    }

    function renderDashboard() {
      document.getElementById('page-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">ç¸½ç”¢å“</div><div class="stat-value">${products.length}</div></div>
          <div class="stat-card"><div class="stat-label">ç¸½è¨‚å–®</div><div class="stat-value">${orders.length}</div></div>
          <div class="stat-card"><div class="stat-label">ç¸½å®¢æˆ¶</div><div class="stat-value">${customers.length}</div></div>
          <div class="stat-card"><div class="stat-label">å„ªæƒ ç¢¼</div><div class="stat-value">${coupons.length}</div></div>
        </div>
        <h2 style="margin: 1.5rem 0 1rem;">æœ€æ–°è¨‚å–®</h2>
        <div class="data-table"><table><thead><tr><th>ID</th><th>å®¢æˆ¶</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th></tr></thead><tbody>${orders.slice(0,5).map(o => `<tr><td>#${o.id}</td><td>${o.customer_name || 'Guest'}</td><td>$${o.total}</td><td><span class="status status-${o.status}">${o.status}</span></td></tr>`).join('')}</tbody></table></div>
      `;
    }

    function renderProducts() {
      document.getElementById('page-content').innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
          <input type="text" placeholder="æœå°‹ç”¢å“..." onkeyup="filterProducts(this.value)" style="padding:0.5rem;border:1px solid var(--border);border-radius:0.5rem;">
          <button class="btn btn-primary" onclick="openProductModal()">â• æ–°å¢ç”¢å“</button>
        </div>
        <div class="data-table"><table><thead><tr><th>ç·¨ç¢¼</th><th>åç¨±</th><th>åƒ¹æ ¼</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr></thead><tbody id="product-list"></tbody></table></div>
      `;
      renderProductList();
    }

    function renderProductList() {
      document.getElementById('product-list').innerHTML = products.map(p => `
        <tr>
          <td>${p.product_code || '-'}</td>
          <td>${p.name || '-'}</td>
          <td>$${p.price || 0}</td>
          <td>${p.stock || 0}</td>
          <td>
            <button class="btn btn-primary" style="padding:0.25rem 0.5rem;font-size:0.75rem" onclick="editProduct(${p.id})">ç·¨è¼¯</button>
            <button class="btn btn-danger" style="padding:0.25rem 0.5rem;font-size:0.75rem" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5">æš«ç„¡ç”¢å“</td></tr>';
    }

    function openProductModal(id = null) {
      document.getElementById('p-id').value = id || '';
      document.getElementById('p-code').value = id ? products.find(p=>p.id===id)?.product_code || '' : '';
      document.getElementById('p-name').value = id ? products.find(p=>p.id===id)?.name || '' : '';
      document.getElementById('p-price').value = id ? products.find(p=>p.id===id)?.price || '' : '';
      document.getElementById('p-stock').value = id ? products.find(p=>p.id===id)?.stock || '' : '';
      document.getElementById('p-category').value = id ? products.find(p=>p.id===id)?.category || '' : 'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«';
      document.getElementById('p-desc').value = id ? products.find(p=>p.id===id)?.description || '' : '';
      document.getElementById('p-image').value = id ? products.find(p=>p.id===id)?.image_url || '' : '';
      document.getElementById('product-modal').classList.add('active');
    }

    function editProduct(id) { openProductModal(id); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    async function deleteProduct(id) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤?')) {
        await fetch(\`/api/products/\${id}\`, { method: 'DELETE' });
        await loadData();
        renderProductList();
      }
    }

    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('p-id').value;
      const data = {
        product_code: document.getElementById('p-code').value,
        name: document.getElementById('p-name').value,
        price: parseInt(document.getElementById('p-price').value) || 0,
        stock: parseInt(document.getElementById('p-stock').value) || 0,
        category: document.getElementById('p-category').value,
        description: document.getElementById('p-desc').value,
        image_url: document.getElementById('p-image').value
      };
      
      const method = id ? 'PUT' : 'POST';
      const url = id ? \`/api/products/\${id}\` : '/api/products';
      
      await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      closeModal('product-modal');
      await loadData();
      renderProductList();
    });

    function renderOrders() {
      document.getElementById('page-content').innerHTML = `
        <div class="data-table"><table><thead><tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>ç”¢å“</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>${orders.map(o => `<tr><td>#${o.id}</td><td>${o.customer_name || 'Guest'}</td><td>${o.items?.length || 0}ä»¶</td><td>$${o.total}</td><td><span class="status status-${o.status}">${o.status}</span></td><td><button class="btn btn-primary" style="padding:0.25rem 0.5rem;font-size:0.75rem" onclick="updateOrderStatus(${o.id}, '${o.status === 'pending' ? 'completed' : 'pending'}')">${o.status === 'pending' ? 'å®Œæˆ' : 'é‡ç½®'}è¨‚å–®</button></td></tr>`).join('') || '<tr><td colspan="6">æš«ç„¡è¨‚å–®</td></tr>'}</tbody></table></div>
      `;
    }

    async function updateOrderStatus(id, status) {
      await fetch(\`/api/orders/\${id}\`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      await loadData();
      renderOrders();
    }

    function renderCustomers() {
      document.getElementById('page-content').innerHTML = `
        <div class="data-table"><table><thead><tr><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>è¨‚å–®æ•¸</th><th>æ¶ˆè²»ç¸½é¡</th></tr></thead><tbody>${customers.map(c => `<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone || '-'}</td><td>${c.orders || 0}</td><td>$${c.total || 0}</td></tr>`).join('') || '<tr><td colspan="5">æš«ç„¡å®¢æˆ¶</td></tr>'}</tbody></table></div>
      `;
    }

    function renderMarketing() {
      // Coupon logic remains local for now as backend doesn't have coupon endpoint yet
      document.getElementById('page-content').innerHTML = `
        <div class="tabs">
          <div class="tab active">å„ªæƒ ç¢¼</div>
          <div class="tab">é–ƒè³¼</div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
          <input type="text" id="coupon-code" placeholder="å„ªæƒ ç¢¼" style="padding:0.5rem;border:1px solid var(--border);border-radius:0.5rem;">
          <input type="text" id="coupon-value" placeholder="æŠ˜æ‰£ (%)" style="padding:0.5rem;border:1px solid var(--border);border-radius:0.5rem;">
          <button class="btn btn-primary" onclick="addCoupon()">æ–°å¢å„ªæƒ ç¢¼</button>
        </div>
        <div class="data-table"><table><thead><tr><th>å„ªæƒ ç¢¼</th><th>æŠ˜æ‰£</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>${coupons.map(c => `<tr><td>${c.code}</td><td>${c.discount}%</td><td><span class="status status-completed">å•Ÿç”¨</span></td><td><button class="btn btn-danger" style="padding:0.25rem 0.5rem;font-size:0.75rem" onclick="deleteCoupon('${c.code}')">åˆªé™¤</button></td></tr>`).join('') || '<tr><td colspan="4">æš«ç„¡å„ªæƒ ç¢¼</td></tr>'}</tbody></table></div>
      `;
    }

    function addCoupon() {
      const code = document.getElementById('coupon-code').value;
      const discount = document.getElementById('coupon-value').value;
      if (code && discount) {
        coupons.push({ code, discount: parseInt(discount) });
        renderMarketing();
      }
    }

    function deleteCoupon(code) {
      coupons = coupons.filter(c => c.code !== code);
      renderMarketing();
    }

    function renderSettings() {
      document.getElementById('page-content').innerHTML = `
        <div class="form-container">
          <h3>ğŸ’³ ä»˜æ¬¾è¨­å®š</h3>
          <div class="form-group">
            <label>éŠ€è¡Œåç¨±</label>
            <input type="text" value="æ†ç”ŸéŠ€è¡Œ">
          </div>
          <div class="form-group">
            <label>å¸³æˆ¶è™Ÿç¢¼</label>
            <input type="text" value="123-456789-001">
          </div>
          <div class="form-group">
            <label>å¸³æˆ¶åç¨±</label>
            <input type="text" value="OHYA2 COMPANY LIMITED">
          </div>
          <button class="btn btn-primary" onclick="alert('è¨­å®šå·²å„²å­˜')">å„²å­˜è¨­å®š</button>
        </div>
        <div class="form-container" style="margin-top:1.5rem;">
          <h3>ğŸšš é‹è²»è¨­å®š</h3>
          <div class="form-group">
            <label>å…é‹é–€æª» (HK$)</label>
            <input type="number" value="300">
          </div>
          <div class="form-group">
            <label>é‹è²» (HK$)</label>
            <input type="number" value="30">
          </div>
          <button class="btn btn-primary" onclick="alert('è¨­å®šå·²å„²å­˜')">å„²å­˜è¨­å®š</button>
        </div>
      `;
    }

    function renderImport() {
      document.getElementById('page-content').innerHTML = `
        <div class="form-container">
          <h3>ğŸ“¥ åŒ¯å…¥ç”¢å“ (CSV)</h3>
          <div class="form-group">
            <label>é¸æ“‡CSVæª”æ¡ˆ</label>
            <input type="file" accept=".csv">
          </div>
          <button class="btn btn-primary">åŒ¯å…¥</button>
        </div>
        <div class="form-container" style="margin-top:1.5rem;">
          <h3>ğŸ“¤ åŒ¯å‡ºç”¢å“</h3>
          <button class="btn btn-primary">åŒ¯å‡ºCSV</button>
        </div>
      `;
    }

    function logout() { location.href = '/'; }

    // Init
    showPage('dashboard');
  </script>
</body>
</html>