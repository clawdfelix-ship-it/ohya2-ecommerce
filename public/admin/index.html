<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
    
    /* Layout */
    .sidebar { width: 240px; background: #0f172a; color: white; position: fixed; height: 100vh; padding: 20px 0; overflow-y: auto; z-index: 100; }
    .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid #1e293b; margin-bottom: 15px; }
    .logo { font-size: 22px; font-weight: bold; color: #ec4899; }
    .logo span { color: white; }
    
    .nav-section { font-size: 11px; text-transform: uppercase; color: #64748b; margin: 20px 15px 8px; letter-spacing: 1px; font-weight: 600; }
    .nav-item { display: flex; align-items: center; gap: 10px; color: #94a3b8; padding: 12px 20px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: #1e293b; color: white; }
    .nav-item.active { background: #1e293b; color: white; border-left-color: #ec4899; }
    .nav-icon { font-size: 16px; width: 24px; text-align: center; }
    
    .main { margin-left: 240px; padding: 24px; min-height: 100vh; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0; }
    .header h1 { font-size: 28px; color: #1e293b; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    
    /* Buttons */
    .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-primary:hover { background: #4f46e5; }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: #475569; }
    
    /* Cards */
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 16px; font-weight: 600; color: #1e293b; }
    .card-body { padding: 20px; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .stat-label { color: #64748b; font-size: 13px; margin-bottom: 4px; }
    .stat-value { font-size: 28px; font-weight: bold; color: #1e293b; }
    .stat-value.success { color: #10b981; }
    .stat-value.warning { color: #f59e0b; }
    .stat-value.danger { color: #ef4444; }
    .stat-change { font-size: 12px; margin-top: 4px; }
    .stat-change.up { color: #10b981; }
    .stat-change.down { color: #ef4444; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
    th { background: #f8fafc; font-weight: 600; color: #475569; font-size: 13px; }
    tr:hover { background: #f8fafc; }
    
    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #6366f1; }
    
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 18px; }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #94a3b8; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end; }
    
    /* Badges */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-processing { background: #dbeafe; color: #1e40af; }
    .badge-shipped { background: #e0e7ff; color: #3730a3; }
    .badge-completed { background: #d1fae5; color: #065f46; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
    .badge-paid { background: #d1fae5; color: #065f46; }
    .badge-unpaid { background: #fee2e2; color: #991b1b; }
    .badge-vip { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .badge-silver { background: linear-gradient(135deg, #94a3b8, #64748b); color: white; }
    .badge-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }
    
    /* Toolbar */
    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-input { padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; width: 280px; }
    .filter-select { padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; min-width: 150px; }
    
    /* Timeline */
    .timeline { padding: 20px; }
    .timeline-item { display: flex; gap: 16px; padding-bottom: 20px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: 11px; top: 24px; bottom: 0; width: 2px; background: #e2e8f0; }
    .timeline-item:last-child::before { display: none; }
    .timeline-dot { width: 24px; height: 24px; border-radius: 50%; background: #6366f1; flex-shrink: 0; }
    .timeline-content { flex: 1; }
    .timeline-time { font-size: 12px; color: #94a3b8; }
    .timeline-text { color: #475569; }
    
    /* Grid */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    
    /* Tags */
    .tag { display: inline-block; padding: 4px 10px; background: #f1f5f9; border-radius: 4px; font-size: 12px; color: #475569; margin-right: 6px; margin-bottom: 6px; }
    
    /* Empty state */
    .empty { text-align: center; padding: 60px 20px; color: #94a3b8; }
    .empty-icon { font-size: 48px; margin-bottom: 16px; }
    
    /* Loading */
    .loading { text-align: center; padding: 60px 20px; color: #64748b; }
    
    @media (max-width: 768px) {
      .sidebar { width: 60px; padding: 10px 0; }
      .sidebar-header, .nav-section, .nav-item span { display: none; }
      .nav-item { justify-content: center; padding: 14px; }
      .nav-icon { font-size: 20px; }
      .main { margin-left: 60px; padding: 16px; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">ğŸ›’ <span>OHYA2.0</span></div>
    </div>
    
    <div class="nav-section">ğŸ“Š ç¸½è¦½</div>
    <div class="nav-item active" onclick="show('dashboard')">
      <span class="nav-icon">ğŸ“Š</span><span>Dashboard</span>
    </div>
    
    <div class="nav-section">ğŸ“¦ è¨‚å–®èˆ‡äº¤æ˜“</div>
    <div class="nav-item" onclick="show('orders')">
      <span class="nav-icon">ğŸ›’</span><span>è¨‚å–®ç®¡ç†</span>
    </div>
    <div class="nav-item" onclick="show('refunds')">
      <span class="nav-icon">ğŸ’¸</span><span>é€€æ¬¾ç®¡ç†</span>
    </div>
    
    <div class="nav-section">ğŸ·ï¸ å•†å“èˆ‡åº«å­˜</div>
    <div class="nav-item" onclick="show('products')">
      <span class="nav-icon">ğŸ“¦</span><span>ç”¢å“ç®¡ç†</span>
    </div>
    <div class="nav-item" onclick="show('inventory')">
      <span class="nav-icon">ğŸ“ˆ</span><span>åº«å­˜ç®¡ç†</span>
    </div>
    <div class="nav-item" onclick="show('categories')">
      <span class="nav-icon">ğŸ·ï¸</span><span>åˆ†é¡ç®¡ç†</span>
    </div>
    
    <div class="nav-section">ğŸ‘¥ é¡§å®¢èˆ‡æœƒå“¡</div>
    <div class="nav-item" onclick="show('customers')">
      <span class="nav-icon">ğŸ‘¥</span><span>å®¢æˆ¶ç®¡ç†</span>
    </div>
    
    <div class="nav-section">ğŸ¯ ç‡ŸéŠ·æ¨å»£</div>
    <div class="nav-item" onclick="show('coupons')">
      <span class="nav-icon">ğŸŸï¸</span><span>å„ªæƒ ç¢¼</span>
    </div>
    <div class="nav-item" onclick="show('promotions')">
      <span class="nav-icon">âš¡</span><span>ä¿ƒéŠ·æ´»å‹•</span>
    </div>
    
    <div class="nav-section">ğŸ“Š æ•¸æ“šåˆ†æ</div>
    <div class="nav-item" onclick="show('analytics')">
      <span class="nav-icon">ğŸ“ˆ</span><span>æ•¸æ“šå ±å‘Š</span>
    </div>
    
    <div class="nav-section">âš™ï¸ ç³»çµ±è¨­å®š</div>
    <div class="nav-item" onclick="show('payments')">
      <span class="nav-icon">ğŸ’³</span><span>ä»˜æ¬¾è¨­å®š</span>
    </div>
    <div class="nav-item" onclick="show('shipping')">
      <span class="nav-icon">ğŸšš</span><span>é‹è²»è¨­å®š</span>
    </div>
    <div class="nav-item" onclick="show('settings')">
      <span class="nav-icon">âš™ï¸</span><span>ç³»çµ±è¨­å®š</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="header">
      <h1 id="page-title">Dashboard</h1>
      <div class="header-right">
        <span style="color:#64748b;font-size:14px;">admin@ohya2.com</span>
        <button class="btn btn-secondary btn-sm" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>
    <div id="content">
      <div class="loading">è¼‰å…¥ç·Š...</div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="product-modal-title">ç”¢å“è³‡æ–™</h2>
        <button class="modal-close" onclick="closeModal('product-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="product-form">
          <input type="hidden" id="p-id">
          <div class="grid-2">
            <div class="form-group">
              <label>ç”¢å“ç·¨ç¢¼ *</label>
              <input type="text" id="p-code" required>
            </div>
            <div class="form-group">
              <label>åˆ†é¡</label>
              <select id="p-category">
                <option value="ã‚ªãƒŠãƒ›ãƒ¼ãƒ«">ã‚ªãƒŠãƒ›ãƒ¼ãƒ«</option>
                <option value="ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•">ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•</option>
                <option value="ãŠã£ã±ã„ã‚°ãƒƒã‚º">ãŠã£ã±ã„ã‚°ãƒƒã‚º</option>
                <option value="æ€§æ„Ÿã‚¯ãƒƒã‚·ãƒ§ãƒ³">æ€§æ„Ÿã‚¯ãƒƒã‚·ãƒ§ãƒ³</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>ç”¢å“åç¨± *</label>
            <input type="text" id="p-name" required>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>åƒ¹æ ¼ (HK$) *</label>
              <input type="number" id="p-price" required>
            </div>
            <div class="form-group">
              <label>åº«å­˜æ•¸é‡</label>
              <input type="number" id="p-stock">
            </div>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>å•†å“é‡é‡ (kg)</label>
              <input type="number" id="p-weight" placeholder="0.5">
            </div>
            <div class="form-group">
              <label>ç‹€æ…‹</label>
              <select id="p-status">
                <option value="active">ä¸Šæ¶ä¸­</option>
                <option value="inactive">ä¸‹æ¶</option>
                <option value="preorder">é å”®</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>ä¸»åœ–ç‰‡ URL</label>
            <input type="text" id="p-image" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>æè¿°</label>
            <textarea id="p-desc" rows="4"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('product-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveProduct()">å„²å­˜ç”¢å“</button>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal" id="order-modal">
    <div class="modal-content" style="max-width:800px;">
      <div class="modal-header">
        <h2>è¨‚å–®è©³æƒ… <span id="order-detail-id"></span></h2>
        <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
      </div>
      <div class="modal-body" id="order-detail-content">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('order-modal')">é—œé–‰</button>
        <button class="btn btn-primary" onclick="saveOrder()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>

  <!-- Customer Modal -->
  <div class="modal" id="customer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="customer-modal-title">å®¢æˆ¶è³‡æ–™</h2>
        <button class="modal-close" onclick="closeModal('customer-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customer-form">
          <input type="hidden" id="c-id">
          <div class="form-group">
            <label>å§“å *</label>
            <input type="text" id="c-name" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="c-email" required>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>é›»è©±</label>
              <input type="text" id="c-phone">
            </div>
            <div class="form-group">
              <label>æœƒå“¡ç­‰ç´š</label>
              <select id="c-level">
                <option value="bronze">Bronze</option>
                <option value="silver">Silver</option>
                <option value="vip">VIP</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>æ¨™ç±¤</label>
            <input type="text" id="c-tags" placeholder="KOL,å¸¸å®¢,æ„›æ®ºåƒ¹ (é€—è™Ÿåˆ†éš”)">
          </div>
          <div class="form-group">
            <label>åœ°å€</label>
            <textarea id="c-address" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>å‚™è¨»</label>
            <textarea id="c-note" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('customer-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveCustomer()">å„²å­˜å®¢æˆ¶</button>
      </div>
    </div>
  </div>

  <!-- Coupon Modal -->
  <div class="modal" id="coupon-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>å„ªæƒ ç¢¼</h2>
        <button class="modal-close" onclick="closeModal('coupon-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="coupon-form">
          <div class="form-group">
            <label>å„ªæƒ ç¢¼ *</label>
            <input type="text" id="coupon-code" required placeholder="SAVE20">
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>æŠ˜æ‰£é¡å‹</label>
              <select id="coupon-type">
                <option value="percent">ç™¾åˆ†æ¯” (%)</option>
                <option value="fixed">å›ºå®šé‡‘é¡ ($)</option>
                <option value="shipping">å…é‹è²»</option>
              </select>
            </div>
            <div class="form-group">
              <label>æŠ˜æ‰£å€¼</label>
              <input type="number" id="coupon-value" required placeholder="20">
            </div>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>æœ€ä½æ¶ˆè²» (HK$)</label>
              <input type="number" id="coupon-min" placeholder="0">
            </div>
            <div class="form-group">
              <label>ä½¿ç”¨æ¬¡æ•¸ä¸Šé™</label>
              <input type="number" id="coupon-limit" placeholder="ç„¡é™">
            </div>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>é–‹å§‹æ—¥æœŸ</label>
              <input type="date" id="coupon-start">
            </div>
            <div class="form-group">
              <label>åˆ°æœŸæ—¥æœŸ</label>
              <input type="date" id="coupon-expire">
            </div>
          </div>
          <div class="form-group">
            <label>é©ç”¨ç¯„åœ</label>
            <select id="coupon-scope">
              <option value="all">å…¨é¤¨é©ç”¨</option>
              <option value="category">æŒ‡å®šåˆ†é¡</option>
              <option value="product">æŒ‡å®šå•†å“</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('coupon-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveCoupon()">æ–°å¢å„ªæƒ ç¢¼</button>
      </div>
    </div>
  </div>

  <!-- New Order Modal -->
  <div class="modal" id="new-order-modal">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h2>å»ºç«‹æ–°è¨‚å–®</h2>
        <button class="modal-close" onclick="closeModal('new-order-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="new-order-form">
          <div class="form-group">
            <label>é¸æ“‡å®¢æˆ¶</label>
            <select id="new-o-customer">
              <option value="">-- é¸æ“‡å®¢æˆ¶ --</option>
            </select>
          </div>
          <div class="form-group">
            <label>é¸æ“‡ç”¢å“</label>
            <select id="new-o-product" onchange="updateOrderCalc()">
              <option value="">-- é¸æ“‡ç”¢å“ --</option>
            </select>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>æ•¸é‡</label>
              <input type="number" id="new-o-qty" value="1" min="1" onchange="updateOrderCalc()">
            </div>
            <div class="form-group">
              <label>å–®åƒ¹</label>
              <input type="number" id="new-o-price" readonly>
            </div>
          </div>
          <div class="form-group">
            <label>é‹è²»</label>
            <input type="number" id="new-o-shipping" value="0">
          </div>
          <div class="form-group">
            <label>å„ªæƒ ç¢¼ (å¦‚æœ‰)</label>
            <input type="text" id="new-o-coupon" placeholder="è¼¸å…¥å„ªæƒ ç¢¼">
          </div>
          <div class="form-group">
            <label>è¨‚å–®å‚™è¨»</label>
            <textarea id="new-o-note" rows="2"></textarea>
          </div>
          <div class="card" style="background:#f8fafc;">
            <div class="grid-2">
              <div>å•†å“é‡‘é¡:</div>
              <div style="text-align:right;" id="new-o-subtotal">$0</div>
            </div>
            <div class="grid-2">
              <div>é‹è²»:</div>
              <div style="text-align:right;" id="new-o-ship-cost">$0</div>
            </div>
            <div class="grid-2">
              <div>å„ªæƒ :</div>
              <div style="text-align:right;color:#10b981;" id="new-o-discount">-$0</div>
            </div>
            <div class="grid-2" style="font-size:18px;font-weight:bold;margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;">
              <div>ç¸½é¡:</div>
              <div style="text-align:right;" id="new-o-total">$0</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('new-order-modal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="createOrder()">å»ºç«‹è¨‚å–®</button>
      </div>
    </div>
  </div>

  <script>
    let products = [], orders = [], customers = [], coupons = [];
    let analytics = {};
    
    // Load data
    Promise.all([
      fetch('/api/products').then(r => r.json()),
      fetch('/api/orders').then(r => r.json()),
      fetch('/api/customers').then(r => r.json()),
      fetch('/api/analytics').then(r => r.json())
    ]).then(([p, o, c, a]) => {
      products = p; orders = o; customers = c; analytics = a;
      renderDashboard();
    }).catch(e => {
      document.getElementById('content').innerHTML = '<div class="empty" style="color:red">Error: ' + e.message + '</div>';
    });
    
    function show(page) {
      document.getElementById('page-title').innerText = {
        dashboard: 'Dashboard', products: 'ç”¢å“ç®¡ç†', categories: 'åˆ†é¡ç®¡ç†',
        inventory: 'åº«å­˜ç®¡ç†', orders: 'è¨‚å–®ç®¡ç†', customers: 'å®¢æˆ¶ç®¡ç†',
        refunds: 'é€€æ¬¾ç®¡ç†', coupons: 'å„ªæƒ ç¢¼', promotions: 'ä¿ƒéŠ·æ´»å‹•',
        analytics: 'æ•¸æ“šå ±å‘Š', payments: 'ä»˜æ¬¾è¨­å®š', shipping: 'é‹è²»è¨­å®š', settings: 'ç³»çµ±è¨­å®š'
      }[page] || page;
      
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      
      if (page === 'dashboard') renderDashboard();
      else if (page === 'products') renderProducts();
      else if (page === 'categories') renderCategories();
      else if (page === 'inventory') renderInventory();
      else if (page === 'orders') renderOrders();
      else if (page === 'customers') renderCustomers();
      else if (page === 'refunds') renderRefunds();
      else if (page === 'coupons') renderCoupons();
      else if (page === 'promotions') renderPromotions();
      else if (page === 'analytics') renderAnalytics();
      else if (page === 'payments') renderPayments();
      else if (page === 'shipping') renderShipping();
      else if (page === 'settings') renderSettings();
    }
    
    // =====================
    // DASHBOARD
    // =====================
    function renderDashboard() {
      const todayOrders = orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        const today = new Date();
        return d.toDateString() === today.toDateString();
      });
      const todayRevenue = todayOrders.reduce((s,o) => s + (o.total||0), 0);
      const pendingOrders = orders.filter(o => o.status === 'pending').length;
      const lowStock = products.filter(p => (p.stock||0) < 5).length;
      
      document.getElementById('content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ä»Šæ—¥è¨‚å–®</div>
            <div class="stat-value">${todayOrders.length}</div>
            <div class="stat-change">${pendingOrders} å¾…è™•ç†</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ä»Šæ—¥ç‡Ÿæ¥­é¡</div>
            <div class="stat-value success">$${todayRevenue}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½ç”¢å“</div>
            <div class="stat-value">${products.length}</div>
            ${lowStock > 0 ? `<div class="stat-change danger">âš ï¸ ${lowStock} ä½åº«å­˜</div>` : ''}
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½å®¢æˆ¶</div>
            <div class="stat-value">${customers.length}</div>
          </div>
        </div>
        
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">ğŸ“¦ ç†±éŠ·ç”¢å“</span>
            </div>
            <div class="card-body">
              <table>
                <thead><tr><th>ç”¢å“</th><th>éŠ·å”®</th></tr></thead>
                <tbody>
                  ${products.slice(0,5).map(p => `<tr><td>${(p.name||'').substring(0,25)}</td><td>${p.stock||0} ä»¶</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <span class="card-title">ğŸ›’ æœ€æ–°è¨‚å–®</span>
              <button class="btn btn-sm btn-primary" onclick="show('orders')">æŸ¥çœ‹å…¨éƒ¨</button>
            </div>
            <div class="card-body">
              <table>
                <thead><tr><th>è¨‚å–®</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody>
                  ${orders.slice(0,5).map(o => `<tr onclick="viewOrder(${o.id})" style="cursor:pointer"><td>#${o.id}</td><td>$${o.total||0}</td><td><span class="badge badge-${o.status}">${o.status}</span></td></tr>`).join('') || '<tr><td colspan="3">æš«ç„¡è¨‚å–®</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }
    
    // =====================
    // PRODUCTS
    // =====================
    function renderProducts() {
      let html = `
        <div class="toolbar">
          <input type="text" class="search-input" placeholder="æœå°‹ç”¢å“..." onkeyup="filterTable(this.value, 'products-table')">
          <select class="filter-select" onchange="filterProductsByCategory(this.value)">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
            ${[...new Set(products.map(p => p.category).filter(Boolean))].map(c => `<option value="${c}">${c}</option>`).join('')}
          </select>
          <button class="btn btn-primary" onclick="openProductModal()">â• æ–°å¢ç”¢å“</button>
        </div>
        <div class="card">
          <table id="products-table">
            <thead><tr><th>ç·¨ç¢¼</th><th>ç”¢å“åç¨±</th><th>åˆ†é¡</th><th>åƒ¹æ ¼</th><th>åº«å­˜</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              ${products.slice(0,50).map(p => `
                <tr>
                  <td>${p.product_code||''}</td>
                  <td>${(p.name||'').substring(0,30)}</td>
                  <td>${p.category||'-'}</td>
                  <td>$${p.price||0}</td>
                  <td style="color:${(p.stock||0) < 5 ? '#ef4444' : ''}">${p.stock||0}</td>
                  <td><span class="badge badge-${p.stock > 0 ? 'completed' : 'cancelled'}">${p.stock > 0 ? 'æœ‰è²¨' : 'ç¼ºè²¨'}</span></td>
                  <td class="actions">
                    <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">ç·¨è¼¯</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
    }
    
    // =====================
    // INVENTORY
    // =====================
    function renderInventory() {
      const lowStock = products.filter(p => (p.stock||0) < 5);
      const outOfStock = products.filter(p => (p.stock||0) === 0);
      const totalStock = products.reduce((s,p) => s + (p.stock||0), 0);
      
      document.getElementById('content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½åº«å­˜ä»¶æ•¸</div>
            <div class="stat-value">${totalStock}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ä½åº«å­˜ (<5)</div>
            <div class="stat-value warning">${lowStock.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å·²ç¼ºè²¨</div>
            <div class="stat-value danger">${outOfStock.length}</div>
          </div>
        </div>
        
        ${lowStock.length > 0 ? `
        <div class="card">
          <div class="card-header">
            <span class="card-title">âš ï¸ éœ€è¦è£œè²¨</span>
          </div>
          <table>
            <thead><tr><th>ç”¢å“</th><th>ç¾æœ‰åº«å­˜</th><th>å»ºè­°è£œè²¨</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              ${lowStock.map(p => `
                <tr>
                  <td>${(p.name||'').substring(0,35)}</td>
                  <td style="color:#ef4444;font-weight:bold">${p.stock}</td>
                  <td>${Math.max(10, p.stock * 2)}</td>
                  <td><button class="btn btn-primary btn-sm" onclick="quickRestock(${p.id})">å¿«é€Ÿè£œè²¨</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        ` : '<div class="card"><p style="color:#10b981">âœ… æ‰€æœ‰ç”¢å“åº«å­˜å……è¶³</p></div>'}
      `;
    }
    
    // =====================
    // ORDERS
    // =====================
    function renderOrders() {
      let html = `
        <div class="toolbar">
          <select id="order-status-filter" class="filter-select" onchange="filterOrders()">
            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="pending">å¾…è™•ç†</option>
            <option value="processing">è™•ç†ä¸­</option>
            <option value="shipped">å·²ç™¼è²¨</option>
            <option value="completed">å·²å®Œæˆ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
          </select>
          <input type="date" id="order-date-from" class="filter-select" onchange="filterOrders()" placeholder="ç”±">
          <input type="date" id="order-date-to" class="filter-select" onchange="filterOrders()" placeholder="è‡³">
          <button class="btn btn-primary" onclick="openNewOrderModal()">â• æ–°å¢è¨‚å–®</button>
        </div>
        <div class="card">
          <table id="orders-table">
            <thead><tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>ä»˜æ¬¾</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="orders-tbody">
              ${orders.map(o => `
                <tr>
                  <td>#${o.id}</td>
                  <td>${o.customer_name||'Guest'}</td>
                  <td>$${o.total||0}</td>
                  <td><span class="badge badge-${o.status}">${o.status}</span></td>
                  <td><span class="badge badge-paid">å·²ä»˜æ¬¾</span></td>
                  <td>${o.created_at ? o.created_at.substring(0,10) : '-'}</td>
                  <td class="actions">
                    <button class="btn btn-primary btn-sm" onclick="viewOrder(${o.id})">è©³æƒ…</button>
                  </td>
                </tr>
              `).join('') || '<tr><td colspan="7">æš«ç„¡è¨‚å–®</td></tr>'}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
    }
    
    function viewOrder(id) {
      const o = orders.find(x => x.id === id);
      if (!o) return;
      
      document.getElementById('order-detail-id').innerText = '#' + o.id;
      document.getElementById('order-detail-content').innerHTML = `
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ“¦ è¨‚å–®è³‡è¨Š</span></div>
            <div class="card-body">
              <div class="form-group">
                <label>è¨‚å–®ç‹€æ…‹</label>
                <select id="o-status">
                  <option value="pending" ${o.status==='pending'?'selected'}>å¾…è™•ç†</option>
                  <option value="processing" ${o.status==='processing'?'selected'}>è™•ç†ä¸­</option>
                  <option value="shipped" ${o.status==='shipped'?'selected'}>å·²ç™¼è²¨</option>
                  <option value="completed" ${o.status==='completed'?'selected'}>å·²å®Œæˆ</option>
                  <option value="cancelled" ${o.status==='cancelled'?'selected'}>å·²å–æ¶ˆ</option>
                </select>
              </div>
              <div class="form-group">
                <label>ç‰©æµå–®è™Ÿ</label>
                <input type="text" id="o-tracking" value="${o.tracking||''}" placeholder="è¼¸å…¥å¿«éå–®è™Ÿ">
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ‘¤ å®¢æˆ¶è³‡è¨Š</span></div>
            <div class="card-body">
              <p><strong>${o.customer_name||'Guest'}</strong></p>
              <p style="color:#64748b">${o.customer_email||''}</p>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ“‹ è¨‚å–®æ™‚é–“è»¸</span></div>
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-time">${o.created_at || 'åˆšåˆš'}</div>
                <div class="timeline-text">è¨‚å–®å·²å»ºç«‹</div>
              </div>
            </div>
            ${o.status !== 'pending' ? `
            <div class="timeline-item">
              <div class="timeline-dot" style="background:#10b981"></div>
              <div class="timeline-content">
                <div class="timeline-time">-</div>
                <div class="timeline-text">è¨‚å–®å·²ç¢ºèª</div>
              </div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ’° è²»ç”¨æ˜ç´°</span></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
              <span>å•†å“å°è¨ˆ</span><span>$${o.total||0}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;">
              <span>é‹è²»</span><span>$0</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;font-size:18px;font-weight:bold;">
              <span>ç¸½é¡</span><span>$${o.total||0}</span>
            </div>
          </div>
        </div>
      `;
      document.getElementById('order-modal').classList.add('active');
    }
    
    // =====================
    // CUSTOMERS
    // =====================
    function renderCustomers() {
      const vipCount = customers.filter(c => (c.total||0) >= 1000).length;
      
      let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½å®¢æˆ¶</div>
            <div class="stat-value">${customers.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">VIP å®¢æˆ¶</div>
            <div class="stat-value warning">${vipCount}</div>
          </div>
        </div>
        
        <div class="toolbar">
          <input type="text" class="search-input" placeholder="æœå°‹å®¢æˆ¶..." onkeyup="filterTable(this.value, 'customers-table')">
          <select class="filter-select">
            <option value="">å…¨éƒ¨ç­‰ç´š</option>
            <option value="vip">VIP</option>
            <option value="silver">Silver</option>
            <option value="bronze">Bronze</option>
          </select>
          <button class="btn btn-primary" onclick="openCustomerModal()">â• æ–°å¢å®¢æˆ¶</button>
        </div>
        
        <div class="card">
          <table id="customers-table">
            <thead><tr><th>ID</th><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>ç­‰ç´š</th><th>æ¶ˆè²»ç¸½é¡</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              ${customers.slice(0,30).map(c => `
                <tr>
                  <td>${c.id}</td>
                  <td>${c.name||'-'}</td>
                  <td>${c.email||'-'}</td>
                  <td>${c.phone||'-'}</td>
                  <td>${(c.total||0) >= 1000 ? '<span class="badge badge-vip">VIP</span>' : (c.total||0) >= 500 ? '<span class="badge badge-silver">Silver</span>' : '<span class="badge badge-bronze">Bronze</span>'}</td>
                  <td>$${c.total||0}</td>
                  <td><button class="btn btn-primary btn-sm" onclick="editCustomer(${c.id})">ç·¨è¼¯</button></td>
                </tr>
              `).join('') || '<tr><td colspan="7">æš«ç„¡å®¢æˆ¶</td></tr>'}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
    }
    
    // =====================
    // REFUNDS
    // =====================
    function renderRefunds() {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ’¸ é€€æ¬¾ç®¡ç†</span>
          </div>
          <div class="card-body">
            <p style="color:#64748b;margin-bottom:20px;">è™•ç†å®¢æˆ¶é€€æ¬¾ç”³è«‹</p>
            <div class="empty">
              <div class="empty-icon">ğŸ’¸</div>
              <p>æš«ç„¡é€€æ¬¾ç”³è«‹</p>
            </div>
          </div>
        </div>
      `;
    }
    
    // =====================
    // COUPONS
    // =====================
    function renderCoupons() {
      let html = `
        <div class="toolbar">
          <button class="btn btn-primary" onclick="openCouponModal()">â• æ–°å¢å„ªæƒ ç¢¼</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>å„ªæƒ ç¢¼</th><th>é¡å‹</th><th>å€¼</th><th>æœ€ä½æ¶ˆè²»</th><th>åˆ°æœŸæ—¥</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              ${coupons.length ? coupons.map(c => `
                <tr>
                  <td><strong>${c.code}</strong></td>
                  <td>${c.type === 'percent' ? '%' : c.type === 'fixed' ? '$' : 'å…é‹'}</td>
                  <td>${c.discount}</td>
                  <td>$${c.min||0}</td>
                  <td>${c.expire||'ç„¡é™'}</td>
                  <td><span class="badge badge-completed">å•Ÿç”¨</span></td>
                  <td><button class="btn btn-danger btn-sm" onclick="deleteCoupon('${c.code}')">åˆªé™¤</button></td>
                </tr>
              `).join('') : '<tr><td colspan="7">æš«ç„¡å„ªæƒ ç¢¼</td></tr>'}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
    }
    
    // =====================
    // PROMOTIONS
    // =====================
    function renderPromotions() {
      document.getElementById('content').innerHTML = `
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><span class="card-title">âš¡ é–ƒè³¼ä¿ƒéŠ·</span></div>
            <div class="card-body">
              <p style="color:#64748b;margin-bottom:15px;">è¨­å®šé™æ™‚ç‰¹åƒ¹</p>
              <button class="btn btn-primary" onclick="alert('é–ƒè³¼åŠŸèƒ½å³å°‡æ¨å‡º')">å»ºç«‹é–ƒè³¼</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">ğŸ åŠ åƒ¹è³¼</span></div>
            <div class="card-body">
              <p style="color:#64748b;margin-bottom:15px">è¨­å®šçµ„åˆå„ªæƒ </p>
              <button class="btn btn-secondary" onclick="alert('åŠ åƒ¹è³¼å³å°‡æ¨å‡º')">å»ºç«‹çµ„åˆ</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ« ç¦®å“å¡</span></div>
          <div class="card-body">
            <p style="color:#64748b;margin-bottom:15px">ç™¼è¡Œé›»å­ç¦®å“å¡</p>
            <button class="btn btn-secondary" onclick="alert('ç¦®å“å¡åŠŸèƒ½å³å°‡æ¨å‡º')">ç™¼è¡Œç¦®å“å¡</button>
          </div>
        </div>
      `;
    }
    
    // =====================
    // ANALYTICS
    // =====================
    function renderAnalytics() {
      const totalRevenue = analytics.totalRevenue || 0;
      const avgOrder = analytics.totalOrders ? Math.round(totalRevenue / analytics.totalOrders) : 0;
      
      document.getElementById('content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½éŠ·å”®é¡</div>
            <div class="stat-value success">$${totalRevenue}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½è¨‚å–®</div>
            <div class="stat-value">${analytics.totalOrders || 0}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å¹³å‡è¨‚å–®é¡</div>
            <div class="stat-value">$${avgOrder}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">è½‰åŒ–ç‡</div>
            <div class="stat-value">-</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ“Š è¨‚å–®ç‹€æ…‹åˆ†ä½ˆ</span></div>
          <div class="card-body">
            ${(analytics.ordersByStatus || []).map(s => `
              <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9;">
                <span><span class="badge badge-${s.status}">${s.status}</span></span>
                <span>${s.count} è¨‚å–®</span>
              </div>
            `).join('') || '<p>æš‚æ— æ•°æ®</p>'}
          </div>
        </div>
      `;
    }
    
    // =====================
    // PAYMENTS
    // =====================
    function renderPayments() {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ’³ ä»˜æ¬¾æ–¹å¼è¨­å®š</span></div>
          <div class="card-body">
            <div class="form-group">
              <label>éŠ€è¡Œè½‰å¸³</label>
              <input type="text" value="æ†ç”ŸéŠ€è¡Œ 123-456789-001">
            </div>
            <div class="form-group">
              <label>FPS è½‰æ•¸å¿«</label>
              <input type="text" value="0123456">
            </div>
            <button class="btn btn-primary">å„²å­˜è¨­å®š</button>
          </div>
        </div>
      `;
    }
    
    // =====================
    // SHIPPING
    // =====================
    function renderShipping() {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸšš é‹è²»è¨­å®š</span></div>
          <div class="card-body">
            <div class="grid-2">
              <div class="form-group">
                <label>å…é‹é–€æª» (HK$)</label>
                <input type="number" value="300">
              </div>
              <div class="form-group">
                <label>åŸºæœ¬é‹è²» (HK$)</label>
                <input type="number" value="30">
              </div>
            </div>
            <div class="form-group">
              <label>åé åœ°å€é¡å¤–é‹è²» (HK$)</label>
              <input type="number" value="20">
            </div>
            <button class="btn btn-primary">å„²å­˜è¨­å®š</button>
          </div>
        </div>
      `;
    }
    
    // =====================
    // SETTINGS
    // =====================
    function renderSettings() {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="card-header"><span class="card-title">âš™ï¸ ç³»çµ±è¨­å®š</span></div>
          <div class="card-body">
            <div class="form-group">
              <label>å•†åº—åç¨±</label>
              <input type="text" value="OHYA2.0">
            </div>
            <div class="form-group">
              <label>è¯ç¹« Email</label>
              <input type="email" value="admin@ohya2.com">
            </div>
            <div class="form-group">
              <label>æ™‚å€</label>
              <select><option>Asia/Hong_Kong</option></select>
            </div>
            <button class="btn btn-primary">å„²å­˜è¨­å®š</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ‘¥ ç®¡ç†å“¡æ¬Šé™</span></div>
          <div class="card-body">
            <p style="color:#64748b;margin-bottom:15px">ç®¡ç†å¾Œå°ç”¨æˆ¶æ¬Šé™</p>
            <table>
              <thead><tr><th>ç”¨æˆ¶</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr></thead>
              <tbody>
                <tr><td>admin@ohya2.com</td><td><span class="badge badge-vip">è¶…ç´šç®¡ç†å“¡</span></td><td>-</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    // =====================
    // CATEGORIES
    // =====================
    function renderCategories() {
      const cats = [...new Set(products.map(p => p.category).filter(Boolean))];
      document.getElementById('content').innerHTML = `
        <div class="toolbar">
          <button class="btn btn-primary">â• æ–°å¢åˆ†é¡</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>åˆ†é¡åç¨±</th><th>ç”¢å“æ•¸é‡</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              ${cats.map(cat => `
                <tr>
                  <td>${cat}</td>
                  <td>${products.filter(p => p.category === cat).length}</td>
                  <td><button class="btn btn-secondary btn-sm">ç·¨è¼¯</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // =====================
    // MODAL FUNCTIONS
    // =====================
    function openProductModal(id) {
      const p = id ? products.find(x => x.id === id) : null;
      document.getElementById('product-modal-title').innerText = id ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“';
      document.getElementById('p-id').value = id || '';
      document.getElementById('p-code').value = p ? p.product_code : '';
      document.getElementById('p-name').value = p ? p.name : '';
      document.getElementById('p-price').value = p ? p.price : '';
      document.getElementById('p-stock').value = p ? p.stock : '';
      document.getElementById('p-category').value = p ? p.category : 'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«';
      document.getElementById('p-image').value = p ? p.image_url : '';
      document.getElementById('p-desc').value = p ? p.description : '';
      document.getElementById('product-modal').classList.add('active');
    }
    
    function openCustomerModal(id) {
      const c = id ? customers.find(x => x.id === id) : null;
      document.getElementById('customer-modal-title').innerText = id ? 'ç·¨è¼¯å®¢æˆ¶' : 'æ–°å¢å®¢æˆ¶';
      document.getElementById('c-id').value = id || '';
      document.getElementById('c-name').value = c ? c.name : '';
      document.getElementById('c-email').value = c ? c.email : '';
      document.getElementById('c-phone').value = c ? c.phone : '';
      document.getElementById('c-address').value = c ? c.address : '';
      document.getElementById('c-level').value = (c && (c.total||0) >= 1000) ? 'vip' : (c && (c.total||0) >= 500) ? 'silver' : 'bronze';
      document.getElementById('customer-modal').classList.add('active');
    }
    
    function openCouponModal() {
      document.getElementById('coupon-form').reset();
      document.getElementById('coupon-modal').classList.add('active');
    }
    
    function openNewOrderModal() {
      const customerSelect = document.getElementById('new-o-customer');
      customerSelect.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option>';
      customers.forEach(c => { customerSelect.innerHTML += '<option value="' + c.id + '">' + (c.name || c.email) + '</option>'; });
      
      const productSelect = document.getElementById('new-o-product');
      productSelect.innerHTML = '<option value="">-- é¸æ“‡ç”¢å“ --</option>';
      products.forEach(p => { productSelect.innerHTML += '<option value="' + p.id + '" data-price="' + p.price + '">' + (p.name || p.product_code).substring(0,25) + ' - $' + p.price + '</option>'; });
      
      document.getElementById('new-order-form').reset();
      document.getElementById('new-o-modal').classList.add('active');
      document.getElementById('new-order-modal').classList.add('active');
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // Save functions
    async function saveProduct() {
      const id = document.getElementById('p-id').value;
      const data = {
        product_code: document.getElementById('p-code').value,
        name: document.getElementById('p-name').value,
        price: parseInt(document.getElementById('p-price').value) || 0,
        stock: parseInt(document.getElementById('p-stock').value) || 0,
        category: document.getElementById('p-category').value,
        image_url: document.getElementById('p-image').value,
        description: document.getElementById('p-desc').value
      };
      const method = id ? 'PUT' : 'POST';
      const url = id ? '/api/products/' + id : '/api/products';
      await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      closeModal('product-modal');
      location.reload();
    }
    
    async function saveCustomer() {
      const id = document.getElementById('c-id').value;
      const data = {
        name: document.getElementById('c-name').value,
        email: document.getElementById('c-email').value,
        phone: document.getElementById('c-phone').value,
        address: document.getElementById('c-address').value
      };
      if (id) {
        await fetch('/api/customers/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      } else {
        await fetch('/api/customers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      }
      closeModal('customer-modal');
      location.reload();
    }
    
    function saveCoupon() {
      coupons.push({
        code: document.getElementById('coupon-code').value,
        type: document.getElementById('coupon-type').value,
        discount: document.getElementById('coupon-value').value,
        min: document.getElementById('coupon-min').value,
        expire: document.getElementById('coupon-expire').value
      });
      closeModal('coupon-modal');
      renderCoupons();
    }
    
    async function saveOrder() {
      const status = document.getElementById('o-status').value;
      const tracking = document.getElementById('o-tracking').value;
      // TODO: Save to API
      closeModal('order-modal');
      alert('è¨‚å–®å·²æ›´æ–°');
    }
    
    async function createOrder() {
      const customerId = document.getElementById('new-o-customer').value;
      const productId = document.getElementById('new-o-product').value;
      const qty = parseInt(document.getElementById('new-o-qty').value) || 1;
      const total = parseInt(document.getElementById('new-o-total').innerText.replace('$','')) || 0;
      
      if (!productId) { alert('è«‹é¸æ“‡ç”¢å“'); return; }
      
      const data = {
        user_id: parseInt(customerId) || null,
        total: total,
        status: 'pending',
        items: [{ product_id: parseInt(productId), quantity: qty, price: total }]
      };
      
      await fetch('/api/orders', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      closeModal('new-order-modal');
      location.reload();
    }
    
    function updateOrderCalc() {
      const productSelect = document.getElementById('new-o-product');
      const selectedOption = productSelect.options[productSelect.selectedIndex];
      const price = parseInt(selectedOption.dataset.price) || 0;
      const qty = parseInt(document.getElementById('new-o-qty').value) || 1;
      const shipping = parseInt(document.getElementById('new-o-shipping').value) || 0;
      
      document.getElementById('new-o-price').value = price;
      document.getElementById('new-o-subtotal').innerText = '$' + (price * qty);
      document.getElementById('new-o-ship-cost').innerText = '$' + shipping;
      document.getElementById('new-o-discount').innerText = '-$0';
      document.getElementById('new-o-total').innerText = '$' + ((price * qty) + shipping);
    }
    
    // Quick actions
    function editProduct(id) { openProductModal(id); }
    function editCustomer(id) { openCustomerModal(id); }
    
    async function deleteProduct(id) {
      if (confirm('ç¢ºå®šåˆªé™¤?')) {
        await fetch('/api/products/' + id, { method: 'DELETE' });
        location.reload();
      }
    }
    
    function deleteCoupon(code) {
      if (confirm('ç¢ºå®šåˆªé™¤?')) {
        coupons = coupons.filter(c => c.code !== code);
        renderCoupons();
      }
    }
    
    async function quickRestock(id) {
      const p = products.find(x => x.id === id);
      if (!p) return;
      const newStock = Math.max(10, (p.stock||0) * 2);
      await fetch('/api/products/' + id, { 
        method: 'PUT', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({ stock: newStock }) 
      });
      location.reload();
    }
    
    function filterTable(query, tableId) {
      const rows = document.querySelectorAll('#' + tableId + ' tbody tr');
      const q = query.toLowerCase();
      rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none'; });
    }
    
    function filterOrders() {
      // Simple filter implementation
    }
    
    function logout() { location.href = '/'; }
  </script>
</body>
</html>
