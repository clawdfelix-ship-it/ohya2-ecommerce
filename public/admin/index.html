<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
    .sidebar { width: 200px; background: #1a1a2e; color: white; position: fixed; height: 100%; padding: 15px; }
    .sidebar h2 { margin-bottom: 15px; font-size: 18px; color: #ec4899; }
    .nav { display: flex; flex-direction: column; gap: 5px; }
    .nav a { color: #aaa; padding: 10px; text-decoration: none; border-radius: 5px; cursor: pointer; }
    .nav a:hover, .nav a.active { background: #16213e; color: white; }
    .main { margin-left: 200px; padding: 20px; }
    .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .stat { font-size: 24px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-completed { background: #d1fae5; color: #065f46; }
    .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .form-group { margin-bottom: 10px; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; }
    .actions { display: flex; gap: 5px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>OHYA2.0</h2>
    <div class="nav">
      <a class="active" onclick="show('dashboard')">ğŸ“Š Dashboard</a>
      <a onclick="show('products')">ğŸ“¦ ç”¢å“</a>
      <a onclick="show('orders')">ğŸ›’ è¨‚å–®</a>
      <a onclick="show('customers')">ğŸ‘¥ å®¢æˆ¶</a>
      <a onclick="show('coupons')">ğŸŸï¸ å„ªæƒ ç¢¼</a>
      <a onclick="show('settings')">âš™ï¸ è¨­å®š</a>
    </div>
  </div>
  <div class="main">
    <div class="header">
      <h1 id="title">Dashboard</h1>
      <button class="btn" onclick="logout()">ç™»å‡º</button>
    </div>
    <div id="content">Loading...</div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <h2>ç”¢å“è³‡æ–™</h2>
      <form id="product-form">
        <input type="hidden" id="p-id">
        <div class="form-group"><label>ç·¨ç¢¼</label><input type="text" id="p-code" required></div>
        <div class="form-group"><label>åç¨±</label><input type="text" id="p-name" required></div>
        <div class="form-group"><label>åƒ¹æ ¼</label><input type="number" id="p-price" required></div>
        <div class="form-group"><label>åº«å­˜</label><input type="number" id="p-stock"></div>
        <div class="form-group"><label>åˆ†é¡</label>
          <select id="p-category">
            <option value="ã‚ªãƒŠãƒ›ãƒ¼ãƒ«">ã‚ªãƒŠãƒ›ãƒ¼ãƒ«</option>
            <option value="ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•">ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•</option>
            <option value="ãŠã£ã±ã„ã‚°ãƒƒã‚º">ãŠã£ã±ã„ã‚°ãƒƒã‚º</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">å„²å­˜</button>
        <button type="button" onclick="closeModal('product-modal')" class="btn">å–æ¶ˆ</button>
      </form>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal" id="order-modal">
    <div class="modal-content">
      <h2>è¨‚å–®è³‡æ–™</h2>
      <form id="order-form">
        <input type="hidden" id="o-id">
        <div class="form-group"><label>å®¢æˆ¶</label><select id="o-customer"></select></div>
        <div class="form-group"><label>ç”¢å“</label><select id="o-product" onchange="calcTotal()"></select></div>
        <div class="form-group"><label>æ•¸é‡</label><input type="number" id="o-qty" value="1" onchange="calcTotal()"></div>
        <div class="form-group"><label>ç¸½é¡</label><input type="number" id="o-total" readonly></div>
        <div class="form-group"><label>ç‹€æ…‹</label>
          <select id="o-status">
            <option value="pending">å¾…è™•ç†</option>
            <option value="processing">è™•ç†ä¸­</option>
            <option value="shipped">å·²ç™¼è²¨</option>
            <option value="completed">å·²å®Œæˆ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">å„²å­˜</button>
        <button type="button" onclick="closeModal('order-modal')" class="btn">å–æ¶ˆ</button>
      </form>
    </div>
  </div>

  <script>
    let products = [], orders = [], customers = [], coupons = [];
    
    // Load data
    fetch('/api/products').then(r => r.json()).then(d => { products = d; renderDashboard(); }).catch(e => { document.getElementById('content').innerHTML = 'Error: ' + e.message; });
    fetch('/api/orders').then(r => r.json()).then(d => orders = d).catch(() => {});
    fetch('/api/customers').then(r => r.json()).then(d => customers = d).catch(() => {});
    
    function show(page) {
      document.getElementById('title').innerText = page;
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      event.target.classList.add('active');
      
      if (page === 'dashboard') renderDashboard();
      else if (page === 'products') renderProducts();
      else if (page === 'orders') renderOrders();
      else if (page === 'customers') renderCustomers();
      else if (page === 'coupons') renderCoupons();
      else if (page === 'settings') renderSettings();
    }
    
    function renderDashboard() {
      document.getElementById('content').innerHTML = 
        '<div class="card"><div>ç¸½ç”¢å“</div><div class="stat">' + products.length + '</div></div>' +
        '<div class="card"><div>ç¸½è¨‚å–®</div><div class="stat">' + orders.length + '</div></div>' +
        '<div class="card"><div>ç¸½å®¢æˆ¶</div><div class="stat">' + customers.length + '</div></div>';
    }
    
    function renderProducts() {
      let html = '<div class="card"><button class="btn btn-primary" onclick="openProduct()">â• æ–°å¢ç”¢å“</button></div>';
      html += '<table><tr><th>ç·¨ç¢¼</th><th>åç¨±</th><th>åƒ¹æ ¼</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr>';
      products.slice(0,30).forEach(p => {
        html += '<tr><td>' + (p.product_code||'') + '</td><td>' + (p.name||'').substring(0,20) + '</td><td>$' + (p.price||0) + '</td><td>' + (p.stock||0) + '</td><td class="actions"><button class="btn btn-primary" style="padding:4px 8px;font-size:12px" onclick="editProduct(' + p.id + ')">ç·¨è¼¯</button></td></tr>';
      });
      html += '</table>';
      document.getElementById('content').innerHTML = html;
    }
    
    function renderOrders() {
      let html = '<div class="card"><button class="btn btn-primary" onclick="openOrder()">â• æ–°å¢è¨‚å–®</button></div>';
      html += '<table><tr><th>ID</th><th>å®¢æˆ¶</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>';
      orders.forEach(o => {
        html += '<tr><td>#' + o.id + '</td><td>' + (o.customer_name||'Guest') + '</td><td>$' + (o.total||0) + '</td><td><span class="badge badge-' + (o.status||'pending') + '">' + (o.status||'pending') + '</span></td><td><button class="btn btn-primary" style="padding:4px 8px;font-size:12px" onclick="editOrder(' + o.id + ')">ç·¨è¼¯</button></td></tr>';
      });
      html += '</table>';
      document.getElementById('content').innerHTML = html;
    }
    
    function renderCustomers() {
      let html = '<table><tr><th>ID</th><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>æ¶ˆè²»</th></tr>';
      customers.slice(0,20).forEach(c => {
        html += '<tr><td>' + c.id + '</td><td>' + (c.name||'-') + '</td><td>' + (c.email||'-') + '</td><td>' + (c.phone||'-') + '</td><td>$' + (c.total||0) + '</td></tr>';
      });
      html += '</table>';
      document.getElementById('content').innerHTML = html;
    }
    
    function renderCoupons() {
      let html = '<div class="card"><button class="btn btn-primary" onclick="addCoupon()">â• æ–°å¢å„ªæƒ ç¢¼</button></div>';
      html += '<table><tr><th>å„ªæƒ ç¢¼</th><th>æ“ä½œ</th></tr>';
      coupons.forEach(c => {
        html += '<tr><td>' + c.code + '</td><td><button class="btn btn-danger" style="padding:4px 8px;font-size:12px" onclick="delCoupon(\'' + c.code + '\')">åˆªé™¤</button></td></tr>';
      });
      html += '</table>';
      document.getElementById('content').innerHTML = html;
    }
    
    function renderSettings() {
      document.getElementById('content').innerHTML = '<div class="card"><h3>ğŸ’³ ä»˜æ¬¾è¨­å®š</h3><p>æ†ç”ŸéŠ€è¡Œ 123-456789-001</p></div><div class="card"><h3>ğŸšš é‹è²»è¨­å®š</h3><p>å…é‹: $300 | é‹è²»: $30</p></div>';
    }
    
    // Modal functions
    function openProduct(id) {
      const p = id ? products.find(x => x.id === id) : null;
      document.getElementById('p-id').value = id || '';
      document.getElementById('p-code').value = p ? p.product_code : '';
      document.getElementById('p-name').value = p ? p.name : '';
      document.getElementById('p-price').value = p ? p.price : '';
      document.getElementById('p-stock').value = p ? p.stock : '';
      document.getElementById('p-category').value = p ? p.category : 'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«';
      document.getElementById('product-modal').classList.add('active');
    }
    function editProduct(id) { openProduct(id); }
    
    function openOrder(id) {
      const sel = document.getElementById('o-customer');
      sel.innerHTML = '<option value="">-- å®¢æˆ¶ --</option>';
      customers.forEach(c => { sel.innerHTML += '<option value="' + c.id + '">' + (c.name||c.email) + '</option>'; });
      
      const sel2 = document.getElementById('o-product');
      sel2.innerHTML = '<option value="">-- ç”¢å“ --</option>';
      products.forEach(p => { sel2.innerHTML += '<option value="' + p.id + '" data-price="' + p.price + '">' + (p.name||p.product_code).substring(0,20) + ' $' + p.price + '</option>'; });
      
      document.getElementById('o-id').value = id || '';
      document.getElementById('o-qty').value = 1;
      document.getElementById('o-total').value = '';
      document.getElementById('order-modal').classList.add('active');
    }
    function editOrder(id) { openOrder(id); }
    
    function calcTotal() {
      const sel = document.getElementById('o-product');
      const opt = sel.options[sel.selectedIndex];
      const price = parseInt(opt.dataset.price) || 0;
      const qty = parseInt(document.getElementById('o-qty').value) || 1;
      document.getElementById('o-total').value = price * qty;
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // Form submissions
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('p-id').value;
      const data = {
        product_code: document.getElementById('p-code').value,
        name: document.getElementById('p-name').value,
        price: parseInt(document.getElementById('p-price').value) || 0,
        stock: parseInt(document.getElementById('p-stock').value) || 0,
        category: document.getElementById('p-category').value
      };
      await fetch(id ? '/api/products/' + id : '/api/products', { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      closeModal('product-modal');
      location.reload();
    });
    
    document.getElementById('order-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('o-id').value;
      const productId = document.getElementById('o-product').value;
      const qty = parseInt(document.getElementById('o-qty').value) || 1;
      const total = parseInt(document.getElementById('o-total').value) || 0;
      
      await fetch('/api/orders', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({
        user_id: parseInt(document.getElementById('o-customer').value) || null,
        total: total,
        status: document.getElementById('o-status').value,
        items: productId ? [{ product_id: parseInt(productId), quantity: qty, price: total }] : []
      })});
      closeModal('order-modal');
      location.reload();
    });
    
    function addCoupon() {
      const code = prompt('å„ªæƒ ç¢¼:');
      if (code) { coupons.push({ code: code }); renderCoupons(); }
    }
    function delCoupon(code) { if (confirm('åˆªé™¤?')) { coupons = coupons.filter(c => c.code !== code); renderCoupons(); } }
    function logout() { location.href = '/'; }
  </script>
</body>
</html>
