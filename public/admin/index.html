<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #ec4899; --background: #f3f4f6; --surface: #ffffff; --text: #1f2937; --text-muted: #6b7280; --border: #e5e7eb; --success: #10b981; --error: #ef4444; --warning: #f59e0b; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--background); color: var(--text); }
    
    /* Layout */
    .admin-layout { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar { width: 260px; background: var(--text); color: white; padding: 1.5rem 0; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar-header { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { font-size: 1.5rem; font-weight: 700; }
    .logo span { color: var(--secondary); }
    
    .sidebar-nav { padding: 1rem 0; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.2s; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
    .nav-item svg { width: 20px; height: 20px; }
    
    /* Main */
    .main { flex: 1; margin-left: 260px; padding: 2rem; }
    
    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .page-title { font-size: 1.75rem; font-weight: 700; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; text-decoration: none; cursor: pointer; border: none; font-size: 0.9375rem; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-danger { background: var(--error); color: white; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border); }
    .stat-label { font-size: 0.875rem; color: var(--text-muted); }
    .stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; }
    
    /* Table */
    .data-table { background: var(--surface); border-radius: 0.75rem; border: 1px solid var(--border); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--background); font-weight: 600; font-size: 0.875rem; }
    td { font-size: 0.9375rem; }
    tr:hover { background: var(--background); }
    .status { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    
    .action-btn { padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; border: none; }
    .edit-btn { background: var(--primary); color: white; }
    .delete-btn { background: var(--error); color: white; }
    
    /* Tabs */
    .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
    .tab { padding: 0.75rem 1rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    /* Form */
    .form-container { background: var(--surface); padding: 2rem; border-radius: 0.75rem; border: 1px solid var(--border); max-width: 600px; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem; font-family: inherit; }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: var(--surface); padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">OHYA<span>2.0</span> Admin</div>
      </div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="showPage('dashboard')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
          Dashboard
        </a>
        <a href="#" class="nav-item" onclick="showPage('products')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          ç”¢å“ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('orders')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
          è¨‚å–®ç®¡ç†
        </a>
        <a href="#" class="nav-item" onclick="showPage('import')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          åŒ¯å…¥/åŒ¯å‡º
        </a>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          è¿”å›ç¶²ç«™
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="page-header">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <div class="user-info">
          <span>Admin</span>
          <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç¸½ç”¢å“æ•¸</div>
            <div class="stat-value" id="stat-products">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            <div class="stat-value" id="stat-orders">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å¾…è™•ç†è¨‚å–®</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æœƒå“¡æ•¸</div>
            <div class="stat-value" id="stat-users">-</div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 1rem;">æœ€æ–°è¨‚å–®</h3>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ—¥æœŸ</th></tr>
            </thead>
            <tbody id="recent-orders"></tbody>
          </table>
        </div>
      </div>

      <!-- Products Page -->
      <div id="page-products" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div class="tabs" style="margin-bottom: 0;">
            <div class="tab active">å…¨éƒ¨ç”¢å“</div>
          </div>
          <button class="btn btn-primary" onclick="showModal('product-modal')">â• æ–°å¢ç”¢å“</button>
        </div>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>ç·¨ç¢¼</th><th>åç¨±</th><th>åƒ¹æ ¼</th><th>åº«å­˜</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="product-list"></tbody>
          </table>
        </div>
      </div>

      <!-- Orders Page -->
      <div id="page-orders" style="display:none;">
        <div class="tabs">
          <div class="tab active" onclick="filterOrders('all')">å…¨éƒ¨</div>
          <div class="tab" onclick="filterOrders('pending')">å¾…è™•ç†</div>
          <div class="tab" onclick="filterOrders('completed')">å·²å®Œæˆ</div>
        </div>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>è¨‚å–®ID</th><th>å®¢æˆ¶</th><th>ç”¢å“</th><th>ç¸½é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="order-list"></tbody>
          </table>
        </div>
      </div>

      <!-- Import/Export Page -->
      <div id="page-import" style="display:none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div class="form-container">
            <h3 style="margin-bottom: 1rem;">ğŸ“¥ åŒ¯å…¥ç”¢å“ (CSV)</h3>
            <div class="form-group">
              <label>é¸æ“‡CSVæª”æ¡ˆ</label>
              <input type="file" accept=".csv" id="import-file">
            </div>
            <button class="btn btn-primary" onclick="importProducts()">åŒ¯å…¥</button>
          </div>
          <div class="form-container">
            <h3 style="margin-bottom: 1rem;">ğŸ“¤ åŒ¯å‡ºç”¢å“ (CSV)</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">åŒ¯å‡ºæ‰€æœ‰ç”¢å“è³‡æ–™ç‚ºCSVæª”æ¡ˆ</p>
            <button class="btn btn-primary" onclick="exportProducts()">åŒ¯å‡ºCSV</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>æ–°å¢/ç·¨è¼¯ç”¢å“</h2>
        <button class="modal-close" onclick="hideModal('product-modal')">&times;</button>
      </div>
      <form id="product-form">
        <div class="form-group">
          <label>ç”¢å“ç·¨ç¢¼</label>
          <input type="text" id="p-code" required>
        </div>
        <div class="form-group">
          <label>ç”¢å“åç¨±</label>
          <input type="text" id="p-name" required>
        </div>
        <div class="form-group">
          <label>åƒ¹æ ¼</label>
          <input type="number" id="p-price" required>
        </div>
        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="p-desc"></textarea>
        </div>
        <div class="form-group">
          <label>åˆ†é¡</label>
          <select id="p-category">
            <option value="ã‚ªãƒŠãƒ›ãƒ¼ãƒ«">ã‚ªãƒŠãƒ›ãƒ¼ãƒ«</option>
            <option value="ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•">ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•</option>
            <option value="ãŠã£ã±ã„ã‚°ãƒƒã‚º">ãŠã£ã±ã„ã‚°ãƒƒã‚º</option>
          </select>
        </div>
        <div class="form-group">
          <label>åº«å­˜</label>
          <input type="number" id="p-stock" value="0">
        </div>
        <button type="submit" class="btn btn-primary">å„²å­˜</button>
      </form>
    </div>
  </div>

  <script>
    let products = [];
    let orders = [];
    
    async function loadData() {
      // Load products
      try {
        const pRes = await fetch('/api/products');
        products = await pRes.json();
        renderProducts();
        document.getElementById('stat-products').textContent = products.length;
      } catch(e) { console.log('No products'); }
      
      // Load orders
      try {
        const oRes = await fetch('/api/orders');
        orders = await oRes.json();
        renderOrders();
        document.getElementById('stat-orders').textContent = orders.length;
        document.getElementById('stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
      } catch(e) { console.log('No orders'); }
    }
    
    function renderProducts() {
      const tbody = document.getElementById('product-list');
      tbody.innerHTML = products.slice(0, 20).map(p => `
        <tr>
          <td>${p.product_code || '-'}</td>
          <td>${p.name || '-'}</td>
          <td>Â¥${p.price || 0}</td>
          <td>${p.stock || 0}</td>
          <td><span class="status ${p.active ? 'status-completed' : 'status-cancelled'}">${p.active ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}</span></td>
          <td>
            <button class="action-btn edit-btn" onclick="editProduct(${p.id})">ç·¨è¼¯</button>
            <button class="action-btn delete-btn" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
          </td>
        </tr>
      `).join('');
    }
    
    function renderOrders() {
      const tbody = document.getElementById('order-list');
      tbody.innerHTML = orders.slice(0, 20).map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${o.user_name || 'User ' + o.user_id}</td>
          <td>${o.total}</td>
          <td><span class="status status-${o.status}">${o.status}</span></td>
          <td>${new Date(o.created_at).toLocaleDateString()}</td>
          <td>
            <button class="action-btn edit-btn" onclick="updateOrderStatus(${o.id})">æ›´æ–°ç‹€æ…‹</button>
          </td>
        </tr>
      `).join('');
      
      // Recent orders
      document.getElementById('recent-orders').innerHTML = orders.slice(0, 5).map(o => `
        <tr>
          <td>#${o.id}</td>
          <td>${o.user_name || 'User ' + o.user_id}</td>
          <td>Â¥${o.total}</td>
          <td><span class="status status-${o.status}">${o.status}</span></td>
          <td>${new Date(o.created_at).toLocaleDateString()}</td>
        </tr>
      `).join('');
    }
    
    function showPage(page) {
      documentSelectorAll('[id.query^="page-"]').forEach(p => p.style.display = 'none');
      document.getElementById('page-' + page).style.display = 'block';
      document.getElementById('page-title').textContent = page === 'dashboard' ? 'Dashboard' : page === 'products' ? 'ç”¢å“ç®¡ç†' : page === 'orders' ? 'è¨‚å–®ç®¡ç†' : 'åŒ¯å…¥/åŒ¯å‡º';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event.target.classList.add('active');
    }
    
    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function hideModal(id) { document.getElementById(id).classList.remove('active'); }
    
    async function exportProducts() {
      window.location.href = '/api/products/export';
    }
    
    async function importProducts() {
      const file = document.getElementById('import-file').files[0];
      if (!file) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
      
      const formData = new FormData();
      formData.append('file', file);
      
      const res = await fetch('/api/products/import', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.success) {
        alert('åŒ¯å…¥æˆåŠŸï¼' + data.imported + ' é …ç”¢å“');
        loadData();
      } else {
        alert('åŒ¯å…¥å¤±æ•—');
      }
    }
    
    function logout() { location.href = '/'; }
    
    loadData();
  </script>
</body>
</html>
