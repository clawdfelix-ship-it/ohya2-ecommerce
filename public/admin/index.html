<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - OHYA2.0</title>
  <style>
    * { margin: 0; padding: 0; }
    body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
    .sidebar { width: 160px; background: #1a1a2e; color: white; position: fixed; height: 100%; padding: 10px; }
    .sidebar h2 { color: #ec4899; margin-bottom: 12px; font-size: 14px; }
    .nav-item { display: block; padding: 10px 12px; color: #9ca3af; border-radius: 6px; cursor: pointer; margin-bottom: 2px; font-size: 13px; }
    .nav-item:hover, .nav-item.active { background: #374151; color: white; }
    .main { margin-left: 160px; padding: 12px; }
    h1 { font-size: 18px; margin-bottom: 12px; }
    .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-sm { padding: 5px 8px; font-size: 11px; }
    .card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    .badge { padding: 3px 6px; border-radius: 10px; font-size: 10px; }
    .badge-pending { background: #fef3c7; }
    .badge-completed { background: #d1fae5; }
    .form-group { margin-bottom: 10px; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 16px; border-radius: 12px; width: 90%; max-width: 400px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
    .row { display: flex; gap: 8px; }
    .col { flex: 1; }
    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
    .stat-card { background: white; padding: 12px; border-radius: 8px; }
    .stat-label { font-size: 11px; color: #666; }
    .stat-value { font-size: 20px; font-weight: bold; }
    .search { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%; margin-bottom: 10px; }
    @media (max-width: 600px) {
      .sidebar { width: 50px; }
      .sidebar h2, .nav-item span { display: none; }
      .nav-item { text-align: center; font-size: 16px; }
      .main { margin-left: 50px; padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>ğŸ›’ OHYA2</h2>
    <div class="nav-item active" onclick="show('dashboard')"><span>ğŸ“Š</span> <span>Dashboard</span></div>
    <div class="nav-item" onclick="show('orders')"><span>ğŸ›’</span> <span>è¨‚å–®</span></div>
    <div class="nav-item" onclick="show('products')"><span>ğŸ“¦</span> <span>ç”¢å“</span></div>
    <div class="nav-item" onclick="show('customers')"><span>ğŸ‘¥</span> <span>å®¢æˆ¶</span></div>
    <div class="nav-item" onclick="show('settings')"><span>âš™ï¸</span> <span>è¨­å®š</span></div>
  </div>
  <div class="main">
    <h1 id="title">Dashboard</h1>
    <div id="content">Loading...</div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="p-title">ç”¢å“</h2><button class="modal-close" onclick="closeModal('product-modal')">&times;</button></div>
      <input type="hidden" id="p-id">
      <div class="form-group"><label>ç·¨ç¢¼</label><input type="text" id="p-code"></div>
      <div class="form-group"><label>åç¨±</label><input type="text" id="p-name"></div>
      <div class="row">
        <div class="col"><div class="form-group"><label>åƒ¹æ ¼</label><input type="number" id="p-price"></div></div>
        <div class="col"><div class="form-group"><label>åº«å­˜</label><input type="number" id="p-stock"></div></div>
      </div>
      <div class="form-group"><label>åˆ†é¡</label>
        <select id="p-category">
          <option value="ã‚ªãƒŠãƒ›ãƒ¼ãƒ«">ã‚ªãƒŠãƒ›ãƒ¼ãƒ«</option>
          <option value="ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•">ãƒ€ãƒƒãƒãƒ¯ã‚¤ãƒ•</option>
          <option value="ãŠã£ã±ã„ã‚°ãƒƒã‚º">ãŠã£ã±ã„ã‚°ãƒƒã‚º</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveProduct()">å„²å­˜</button>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal" id="order-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>æ–°è¨‚å–®</h2><button class="modal-close" onclick="closeModal('order-modal')">&times;</button></div>
      <div class="form-group"><label>ç”¢å“</label><select id="o-product"></select></div>
      <div class="row">
        <div class="col"><div class="form-group"><label>æ•¸é‡</label><input type="number" id="o-qty" value="1" onchange="calcOrder()"></div></div>
        <div class="col"><div class="form-group"><label>å–®åƒ¹</label><input type="number" id="o-unit" readonly></div></div>
      </div>
      <div class="form-group"><label>ç¸½é¡</label><input type="number" id="o-total" readonly></div>
      <div class="form-group"><label>ç‹€æ…‹</label>
        <select id="o-status">
          <option value="pending">å¾…è™•ç†</option>
          <option value="processing">è™•ç†ä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
          <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveOrder()">å»ºç«‹è¨‚å–®</button>
    </div>
  </div>

  <script>
    var products = [], orders = [], customers = [];
    
    // Load analytics on start
    fetch('/api/analytics').then(r => r.json()).then(function(d) {
      renderDashboard(d);
    });
    
    function show(page) {
      document.getElementById('title').innerText = {dashboard:'Dashboard', orders:'è¨‚å–®', products:'ç”¢å“', customers:'å®¢æˆ¶', settings:'è¨­å®š'}[page];
      document.querySelectorAll('.nav-item').forEach(function(el){ el.classList.remove('active'); });
      event.target.classList.add('active');
      
      if (page === 'dashboard') fetch('/api/analytics').then(r=>r.json()).then(renderDashboard);
      else if (page === 'orders') loadOrders();
      else if (page === 'products') loadProducts();
      else if (page === 'customers') loadCustomers();
      else if (page === 'settings') renderSettings();
    }
    
    function renderDashboard(d) {
      document.getElementById('content').innerHTML = 
        '<div class="stats">' +
        '<div class="stat-card"><div class="stat-label">ç”¢å“</div><div class="stat-value">'+d.totalProducts+'</div></div>' +
        '<div class="stat-card"><div class="stat-label">è¨‚å–®</div><div class="stat-value">'+d.totalOrders+'</div></div>' +
        '<div class="stat-card"><div class="stat-label">å®¢æˆ¶</div><div class="stat-value">'+d.totalCustomers+'</div></div>' +
        '<div class="stat-card"><div class="stat-label">éŠ·å”®é¡</div><div class="stat-value">$'+(d.totalRevenue||0)+'</div></div>' +
        '</div>';
    }
    
    function loadOrders() {
      fetch('/api/orders').then(r=>r.json()).then(function(d) {
        orders = d;
        var html = '<button class="btn btn-primary" onclick="openOrder()">+ æ–°å¢è¨‚å–®</button><input class="search" placeholder="æœå°‹..." onkeyup="filter(this.value)"><table id="tbl"><tr><th>ID</th><th>å®¢æˆ¶</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>';
        html += orders.slice(0,30).map(function(o){ return '<tr><td>#'+o.id+'</td><td>'+(o.customer_name||'Guest')+'</td><td>$'+(o.total||0)+'</td><td><span class="badge badge-'+(o.status||'pending')+'">'+(o.status||'pending')+'</span></td><td><button class="btn btn-primary btn-sm" onclick="updateStatus('+o.id+')">ç‹€æ…‹</button></td></tr>'; }).join('');
        html += '</table>';
        document.getElementById('content').innerHTML = html;
      });
    }
    
    function loadProducts() {
      fetch('/api/products').then(r=>r.json()).then(function(d) {
        products = d;
        var html = '<button class="btn btn-primary" onclick="openProduct()">+ æ–°å¢ç”¢å“</button><input class="search" placeholder="æœå°‹..." onkeyup="filter(this.value)"><table id="tbl"><tr><th>ç·¨ç¢¼</th><th>åç¨±</th><th>åƒ¹æ ¼</th><th>åº«å­˜</th><th>æ“ä½œ</th></tr>';
        html += products.slice(0,30).map(function(p){ return '<tr><td>'+(p.product_code||'')+'</td><td>'+(p.name||'').substring(0,15)+'</td><td>$'+(p.price||0)+'</td><td style="color:'+((p.stock||0)<5?'red':'')+'">'+(p.stock||0)+'</td><td><button class="btn btn-primary btn-sm" onclick="editProduct('+p.id+')">ç·¨è¼¯</button> <button class="btn btn-danger btn-sm" onclick="delProduct('+p.id+')">åˆª</button></td></tr>'; }).join('');
        html += '</table>';
        document.getElementById('content').innerHTML = html;
      });
    }
    
    function loadCustomers() {
      fetch('/api/customers').then(r=>r.json()).then(function(d) {
        customers = d;
        var html = '<table id="tbl"><tr><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>æ¶ˆè²»</th></tr>';
        html += customers.slice(0,30).map(function(c){ return '<tr><td>'+(c.name||'-')+'</td><td>'+(c.email||'-')+'</td><td>'+(c.phone||'-')+'</td><td>$'+(c.total||0)+'</td></tr>'; }).join('');
        html += '</table>';
        document.getElementById('content').innerHTML = html;
      });
    }
    
    function renderSettings() {
      document.getElementById('content').innerHTML = '<div class="card"><b>éŠ€è¡Œ:</b> æ†ç”ŸéŠ€è¡Œ 123-456789-001</div><div class="card"><b>é‹è²»:</b> å…é‹$300, å…¶ä»–$30</div>';
    }
    
    // Modal functions
    function openProduct(id) {
      var p = id ? products.find(function(x){return x.id===id;}) : null;
      document.getElementById('p-title').innerText = id ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“';
      document.getElementById('p-id').value = id||'';
      document.getElementById('p-code').value = p?p.product_code:'';
      document.getElementById('p-name').value = p?p.name:'';
      document.getElementById('p-price').value = p?p.price:'';
      document.getElementById('p-stock').value = p?p.stock:'';
      document.getElementById('p-category').value = p?p.category:'ã‚ªãƒŠãƒ›ãƒ¼ãƒ«';
      document.getElementById('product-modal').classList.add('active');
    }
    
    function openOrder() {
      var sel = document.getElementById('o-product');
      sel.innerHTML = '';
      products.forEach(function(p){ sel.innerHTML += '<option value="'+p.id+'" data-price="'+p.price+'">'+(p.name||p.product_code).substring(0,20)+' $'+p.price+'</option>'; });
      document.getElementById('order-modal').classList.add('active');
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function calcOrder() {
      var sel = document.getElementById('o-product');
      var price = parseInt(sel.options[sel.selectedIndex]?.dataset.price) || 0;
      var qty = parseInt(document.getElementById('o-qty').value) || 1;
      document.getElementById('o-unit').value = price;
      document.getElementById('o-total').value = price * qty;
    }
    
    // Save functions
    async function saveProduct() {
      var id = document.getElementById('p-id').value;
      var data = { product_code: document.getElementById('p-code').value, name: document.getElementById('p-name').value, price: parseInt(document.getElementById('p-price').value)||0, stock: parseInt(document.getElementById('p-stock').value)||0, category: document.getElementById('p-category').value };
      await fetch(id?'/api/products/'+id:'/api/products', {method:id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
      closeModal('product-modal');
      loadProducts();
    }
    
    async function saveOrder() {
      var pid = document.getElementById('o-product').value;
      var qty = parseInt(document.getElementById('o-qty').value)||1;
      var total = parseInt(document.getElementById('o-total').value)||0;
      await fetch('/api/orders', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({total:total, status:document.getElementById('o-status').value, items:[{product_id:parseInt(pid), quantity:qty, price:total}]})});
      closeModal('order-modal');
      loadOrders();
    }
    
    // Quick actions
    function editProduct(id) { openProduct(id); }
    async function delProduct(id) { if(confirm('ç¢ºå®š?')){ await fetch('/api/products/'+id,{method:'DELETE'}); loadProducts(); }}
    async function updateStatus(id) {
      var s = prompt('ç‹€æ…‹ (pending/processing/completed/cancelled):');
      if(s){ await fetch('/api/orders/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:s})}); loadOrders(); }
    }
    function filter(q) {
      var rows = document.querySelectorAll('#tbl tr');
      q = q.toLowerCase();
      rows.forEach(function(r){ r.style.display = r.textContent.toLowerCase().indexOf(q)>=0?'':'none'; });
    }
  </script>
</body>
</html>
